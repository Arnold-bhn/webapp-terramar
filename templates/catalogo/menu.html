{% extends 'base.html' %}
{% load cart_tags %} 

{% block content %}

    <style>
        .img-agotada { filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .btn-agotado { cursor: not-allowed !important; background-color: #6c757d; border-color: #6c757d; color: white; }
        
        /* ESTILOS BOTONES DE MARCA */
        .btn-marca-custom {
            cursor: pointer;
            color: #6c757d;
            font-weight: bold;
            border: 1px solid #dee2e6;
            margin: 0 5px;
            border-radius: 50rem;
            background: white;
            padding: 8px 16px;
            transition: background-color 0.2s, color 0.2s;
        }

        .btn-marca-custom.activo {
            background-color: #0d6efd !important;
            color: white !important;
            border-color: #0d6efd !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-marca-custom:hover:not(.activo) {
            background-color: #f8f9fa;
        }

        .marcas-sticky-panel {
            position: sticky; 
            top: 50px; 
            z-index: 1040; 
            background-color: #f8f9fa; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            padding: 10px 0;
        }
        
        .contenido-menu-wrapper {
            min-height: 400px; /* Evita saltos bruscos si carga lento */
        }
    </style>

    <div class="text-center mb-4 mt-4" style="margin-top: 70px !important;"> 
        <h1 class="display-6 fw-bold text-secondary">Nuestra Carta</h1>
        <p class="text-muted">Selecciona tus platos favoritos</p>
    </div>

    <div class="container marcas-sticky-panel"> 
        <div class="d-flex justify-content-center flex-wrap">
            {% for m in todas_marcas %}
                <button type="button" 
                        class="btn-marca-custom {% if marca_actual and m.id == marca_actual.id %}activo{% endif %}"
                        id="btn-marca-{{ m.slug }}"
                        onclick="cargarMarca(event, '{{ m.slug }}')">
                    {{ m.nombre|upper }}
                </button>
            {% endfor %}
        </div>
    </div>

    <div class="container mb-5 contenido-menu-wrapper" id="platos-container">
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"><i class="fas fa-check-circle me-2"></i> ¡Agregado!</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        {% include 'catalogo/platos_list.html' %} 
    </div>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES PARA MEMORIA DE SCROLL
        // ==========================================
        
        // Objeto para guardar posiciones: { 'terramar': 1200, 'a-fuego': 500 }
        const memoriaScroll = {}; 
        
        // Guardamos cuál es la marca actual al cargar la página por primera vez
        let marcaActualGlobal = "{{ marca_actual.slug|default:'' }}"; 

        // ==========================================
        // 1. FUNCIÓN DE CARGA CON MEMORIA
        // ==========================================
        function cargarMarca(event, slug) {
            event.preventDefault();
            
            // Si ya estamos en esta marca, no hacemos nada
            if (slug === marcaActualGlobal) return;

            console.log(`Cambiando de ${marcaActualGlobal} a ${slug}`);

            // A. GUARDAR MEMORIA: Antes de irnos, guardamos dónde estamos scrolleados
            memoriaScroll[marcaActualGlobal] = window.scrollY;
            
            // B. ACTUALIZAR REFERENCIA: Ahora la marca actual será la nueva
            marcaActualGlobal = slug;

            const contenedor = document.getElementById('platos-container');
            const url = `/ajax/platos/${slug}/`;

            // Efecto visual
            contenedor.style.opacity = '0.4';

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Error servidor');
                    return response.text();
                })
                .then(html => {
                    // C. CAMBIAR CONTENIDO
                    contenedor.innerHTML = html;

                    // D. ACTUALIZAR BOTONES
                    document.querySelectorAll('.btn-marca-custom').forEach(btn => btn.classList.remove('activo'));
                    const btnActivo = document.getElementById('btn-marca-' + slug);
                    if(btnActivo) btnActivo.classList.add('activo');

                    // E. REACTIVAR FORMULARIOS
                    activarFormulariosCarrito();

                    // F. RESTAURAR SCROLL (LA MAGIA)
                    contenedor.style.opacity = '1';

                    if (memoriaScroll[slug] !== undefined) {
                        // Si ya habíamos estado aquí, volvemos a esa posición exacta
                        // Usamos un pequeño timeout para asegurar que el navegador renderizó la altura
                        setTimeout(() => {
                            window.scrollTo({
                                top: memoriaScroll[slug],
                                behavior: 'auto' // 'auto' es instantáneo, 'smooth' es suave
                            });
                        }, 10);
                    } else {
                        // Si es la primera vez que entramos a esta marca, vamos al inicio (arriba)
                        // pero respetando el sticky header (ajustamos a 0 o un poco más abajo si quieres)
                        window.scrollTo(0, 0);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    contenedor.style.opacity = '1';
                });
        }

        // ==========================================
        // 2. LÓGICA DEL CARRITO (Igual que antes)
        // ==========================================
        function activarFormulariosCarrito() {
            const forms = document.querySelectorAll('.form-ajax');
            const toastEl = document.getElementById('liveToast');
            const toast = toastEl ? new bootstrap.Toast(toastEl) : null;
            const cartCounter = document.getElementById('cart-count');

            forms.forEach(form => {
                if (form.getAttribute('data-listo') === 'si') return;
                form.setAttribute('data-listo', 'si');

                form.addEventListener('submit', function (e) {
                    e.preventDefault(); 
                    const url = this.action;
                    const formData = new FormData(this);
                    const btn = this.querySelector('.btn-agregar');
                    const badge = this.querySelector('span[id^="badge-"]');
                    const originalText = btn.innerHTML;

                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    fetch(url, {
                        method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            if(toast) toast.show();
                            if(cartCounter) {
                                cartCounter.innerText = data.cant_total;
                                cartCounter.classList.remove('d-none');
                            }
                            if(badge) {
                                badge.innerText = data.cant_producto;
                                badge.classList.remove('d-none');
                                badge.classList.add('bg-success');
                                setTimeout(() => {
                                    badge.classList.remove('bg-success');
                                    badge.classList.add('bg-dark');
                                }, 500);
                            }
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        } else {
                            Swal.fire({ icon: 'error', title: 'Oops...', text: data.message });
                            btn.innerHTML = 'Agotado';
                            btn.disabled = true;
                        }
                    })
                    .catch(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    });
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            activarFormulariosCarrito();
        });
    </script>

{% endblock %}