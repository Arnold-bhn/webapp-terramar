

============================================================
ARCHIVO: .\catalogo\admin.py
============================================================
from django.contrib import admin
from .models import InsumoCritico, Categoria, Plato, Variante
from django.utils.safestring import mark_safe
from django.utils.html import format_html
from django.urls import reverse

# Register your models here.
# Esto permite poner los precios DENTRO de la pantalla del Plato
'''class VarianteInline(admin.TabularInline):
    model = Variante
    extra = 1
'''
# 1. Configuraci√≥n de la "Tablita" dentro del Plato
class VarianteInline(admin.TabularInline):
    model = Variante
    # 'extra = 0' hace que no salgan filas vac√≠as extra, 
    # pero si no ves nada, prueba cambiarlo a 1 para ver si aparece al menos la fila de "Agregar nuevo".
    extra = 0 
    
    # Campos que quieres ver y editar ah√≠ mismo
    fields = ('nombre', 'precio', 'activo')
    
    # IMPORTANTE: Quitamos 'classes': ['collapse'] para que SIEMPRE se vean
    
    # Esto ayuda si tienes muchas variantes, para que no ocupen tanto espacio vertical
    show_change_link = True

@admin.register(InsumoCritico)
class InsumoAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'sede', 'disponible')
    list_editable = ('disponible',) # Switch r√°pido
    list_filter = ('sede',)

@admin.register(Categoria)
class CategoriaAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'marca', 'orden', 'activo')
    list_editable = ('orden', 'activo')
    list_filter = ('marca',)

@admin.register(Plato)
class PlatoAdmin(admin.ModelAdmin):
    # 1. AGREGAMOS 'control_variantes' AQUI EN LA LISTA VISIBLE
    list_display = ('nombre_completo', 'categoria', 'orden', 'activo_manual', 'control_variantes')
    
    list_filter = ('marca', 'categoria')
    list_editable = ('orden', 'activo_manual')
    search_fields = ('nombre',)
    # inlines = [VarianteInline] # Descomenta esto si tienes tu Inline definido arriba
    filter_horizontal = ('insumos_clave',)

    @admin.display(description='Plato', ordering='nombre')
    def nombre_completo(self, obj):
        return str(obj)

    # --- AQU√ç EST√Å TU M√âTODO ARREGLADO ---
    def control_variantes(self, obj):
        html_parts = []
        
        # Recorremos todas las variantes de este plato
        for variante in obj.variantes.all():
            if variante.activo:
                color = "#198754" # Verde (ON)
                estado = "ON"
                opacity = "1"
            else:
                color = "#dc3545" # Rojo (OFF)
                estado = "OFF"
                opacity = "0.6" # Un poco transparente si est√° apagado
            
            # Ahora esta l√≠nea YA FUNCIONAR√Å porque creamos la URL en el Paso 2
            url = reverse('toggle_variante', args=[variante.id])
            
            boton = f"""
            <a href="{url}" style="
                display: inline-block;
                padding: 4px 8px;
                margin: 2px;
                background-color: {color};
                color: white;
                text-decoration: none;
                border-radius: 4px;
                font-size: 11px;
                font-weight: bold;
                border: 1px solid #000;
                opacity: {opacity};
                box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            " title="Clic para cambiar estado">
                {variante.nombre}: {estado}
            </a>
            """
            html_parts.append(boton)
        
        if not html_parts:
            return "-"

        return mark_safe("".join(html_parts))
    
    control_variantes.short_description = "Variantes (Clic para alternar)"


# Registramos Variante suelta tambi√©n por si necesitamos buscar precios espec√≠ficos
@admin.register(Variante)
class VarianteAdmin(admin.ModelAdmin):
    # Columnas que ver√°s
    list_display = ('obtener_nombre_completo', 'precio', 'activo')
    
    # ESTO ES LA MAGIA: Te permite editar el check sin entrar
    list_editable = ('activo', 'precio') 
    
    # Filtros laterales para encontrar r√°pido (por marca o categor√≠a del plato padre)
    list_filter = ('activo', 'plato__marca', 'plato__categoria')
    
    # Buscador (busca por nombre de variante O nombre del plato)
    search_fields = ('nombre', 'plato__nombre')
    
    # Ordenar por plato para que salgan agrupados
    ordering = ('plato',)

    # Funci√≥n para que en la lista se vea "Ceviche - Personal" y no solo "Personal"
    @admin.display(description='Producto')
    def obtener_nombre_completo(self, obj):
        return f"{obj.plato.nombre} - {obj.nombre}"

============================================================
ARCHIVO: .\catalogo\apps.py
============================================================
from django.apps import AppConfig


class CatalogoConfig(AppConfig):
    name = 'catalogo'


============================================================
ARCHIVO: .\catalogo\models.py
============================================================
from django.db import models
from core.models import Marca, Sede
# Create your models here.

# Gestion de Stokc Cr√≠tico
class InsumoCritico(models.Model):
    sede = models.ForeignKey(Sede, on_delete=models.CASCADE, related_name='insumos')
    nombre = models.CharField(max_length=50, help_text="Ej: Pescado, Lim√≥n, Gas")
    disponible = models.BooleanField(default=True, help_text="Desmarcar para apagar todos los platos relacionados")

    def __str__(self):
        estado = "‚úÖ" if self.disponible else "‚ùå AGOTADO"
        return f"{self.nombre} ({self.sede.nombre}) - {estado}"

# Categorias (Entradas, Bebidas, Fondos, etc)
class Categoria(models.Model):
    marca = models.ForeignKey(Marca, on_delete=models.CASCADE, related_name='categorias')
    nombre = models.CharField(max_length=50)
    nombre_singular = models.CharField(
        max_length=50, 
        blank=True, 
        null=True, 
        help_text="Ej: 'Chicharron' (para que salga 'Chicharron de Pollo')"
    )
    #imagen = models.ImageField(upload_to='categorias/', blank=True, null=True)
    orden = models.IntegerField(default=0, help_text="1 sale primero, 2 despu√©s ...")
    activo = models.BooleanField(default=True)
    class Meta:
        ordering = ['orden']
    def __str__(self):
        return f"{self.marca.nombre} - {self.nombre}"
    
# Platos
class Plato(models.Model):
    marca = models.ForeignKey(Marca, on_delete=models.CASCADE, related_name='platos')
    categoria = models.ForeignKey(Categoria, on_delete=models.CASCADE, related_name='platos')
    nombre = models.CharField(max_length=100)
    descripcion = models.TextField(blank=True, help_text="Descripci√≥n para la web")
    imagen = models.ImageField(upload_to='platos/', blank=True, null=True)
    activo_manual = models.BooleanField(default=True, help_text="Apagar este plato manualmente")
    # Si se acaba el 'Insumo Cr√≠tico', el plato se apaga solo
    insumos_clave = models.ManyToManyField(InsumoCritico, blank=True)
    orden = models.IntegerField(default=0, help_text="1 sale primero, 2 despu√©s...")
    # --- CONFIGURACI√ìN DE ORDENAMIENTO ---
    class Meta:
        # Ordena primero por 'orden' (ascendente) y luego por 'nombre' (si tienen el mismo n√∫mero)
        ordering = ['orden', 'nombre']
    def __str__(self):
        # 1. Intentamos usar el singular (si el admin lo escribi√≥)
        if self.categoria.nombre_singular:
            prefijo = self.categoria.nombre_singular
        else:
            # 2. Si no, usamos el plural por defecto
            prefijo = self.categoria.nombre
            
        return f"{prefijo} de {self.nombre}"
    
    # --- AQU√ç EST√Å LA MAGIA (El Portero) ---
    @property
    def esta_disponible(self):
        """
        Devuelve True SOLO si:
        1. El interruptor manual est√° encendido (activo_manual=True)
        2. Y ADEM√ÅS, no hay ning√∫n insumo cr√≠tico marcado como agotado.
        """
        # 1. Revisar interruptor manual
        if not self.activo_manual:
            return False
            
        # 2. Revisar insumos autom√°ticos
        # Buscamos si existe algun insumo vinculado que tenga disponible=False
        hay_insumos_agotados = self.insumos_clave.filter(disponible=False).exists()
        
        if hay_insumos_agotados:
            return False # Bloqueamos el paso
            
        return True # Todo ok, pase usted

# En catalogo/models.py
class Variante(models.Model):
    plato = models.ForeignKey(Plato, on_delete=models.CASCADE, related_name='variantes')
    nombre = models.CharField(max_length=50, default="Est√°ndar", help_text="Ej: Personal, Fuente, Vaso")
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    
    # --- NUEVO CAMPO: Interruptor individual ---
    activo = models.BooleanField(default=True, verbose_name="¬øDisponible?", help_text="Desmarcar si se agot√≥ solo esta presentaci√≥n")
    
    def __str__(self):
        return f"{self.plato.nombre} - {self.nombre} (S/ {self.precio})"

    # --- L√ìGICA DE DISPONIBILIDAD ACTUALIZADA ---
    @property
    def esta_disponible(self):
        """
        La variante est√° disponible SI:
        1. Ella misma est√° activa (activo=True).
        2. Y SU PAP√Å (El Plato) tambi√©n est√° disponible (tiene insumos y est√° activo).
        """          
        # 2. Chequeo del padre (¬øQueda pescado para cocinar?)
        return self.activo and self.plato.esta_disponible
    


============================================================
ARCHIVO: .\catalogo\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARCHIVO: .\catalogo\views.py
============================================================
from django.shortcuts import render
from .models import Categoria, Plato
from pedidos.carrito import Carrito
from django.shortcuts import get_object_or_404, redirect
from django.contrib.admin.views.decorators import staff_member_required
from .models import Variante

def menu_digital(request):
    """
    Vista principal: Muestra el men√∫ completo.
    """
    # 1. Obtenemos las categor√≠as activas
    categorias = Categoria.objects.all().prefetch_related(
        'platos', 
        'platos__insumos_clave', # <--- ESTO ES VITAL: Trae los insumos en la misma consulta
        'platos__variantes'
    )


    carrito = Carrito(request)
    
    # 2. Empaquetamos los datos para enviarlos
    context = {
        'categorias': categorias,
        'carrito': carrito,
    }
    
    # 3. Renderizamos el HTML
    return render(request, 'catalogo/menu.html', context)

@staff_member_required # Solo administradores pueden usar esto
def toggle_variante(request, variante_id):
    variante = get_object_or_404(Variante, id=variante_id)
    variante.activo = not variante.activo # Aqu√≠ invertimos el estado (On <-> Off)
    variante.save()
    
    # Nos devuelve a la p√°gina donde est√°bamos (el admin)
    return redirect(request.META.get('HTTP_REFERER', '/admin/'))

============================================================
ARCHIVO: .\catalogo\__init__.py
============================================================


============================================================
ARCHIVO: .\catalogo\templatetags\cart_tags.py
============================================================
from django import template

register = template.Library()

@register.filter(name='cantidad_en_carrito')
def cantidad_en_carrito(carrito, producto_id):
    # Intentamos buscar el ID (como string) dentro del diccionario del carrito
    if not carrito or not carrito.carrito:
        return 0
    
    item = carrito.carrito.get(str(producto_id))
    if item:
        return item['cantidad']
    return 0

============================================================
ARCHIVO: .\catalogo\templatetags\__init__.py
============================================================


============================================================
ARCHIVO: .\config\asgi.py
============================================================
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()


============================================================
ARCHIVO: .\config\settings.py
============================================================
"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 5.1.7.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.1/ref/settings/
"""

from pathlib import Path
import os
import environ

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.1/howto/deployment/checklist/
env = environ.Env()
env_file = BASE_DIR / '.env'

if env_file.exists():
    environ.Env.read_env(str(env_file))
else:
    print(f"‚ö†Ô∏è  ALERTA: No encuentro el archivo en: {env_file}")
    print("‚ö†Ô∏è  Verifica que el archivo se llame '.env' y no '.env.txt'")

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = env('SECRET_KEY', default='django-insecure-clave-de-respaldo-para-desarrollo')
# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = env.bool('DEBUG', default = False)

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'jazzmin',
    #'unfold', #tema blanco
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    #Mis Archivos Terramar
    'core',
    'catalogo',
    'pedidos',
    'dashboard',
    'admin_reorder',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'admin_reorder.middleware.ModelAdminReorder',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'core.context_processors.informacion_marca',
                'pedidos.context_processors.carrito_actual',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.1/topics/i18n/

LANGUAGE_CODE = 'es-pe'

TIME_ZONE = 'America/Lima'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.1/howto/static-files/

STATIC_URL = 'static/'

# URL p√∫blica (lo que escribe el navegador)
MEDIA_URL = '/media/'

# Ruta f√≠sica (d√≥nde se guardan en tu PC)
MEDIA_ROOT = BASE_DIR / 'media'

# Default primary key field type
# https://docs.djangoproject.com/en/5.1/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


# --- CONFIGURACI√ìN DE JAZZMIN (ADMIN PANEL) ---

JAZZMIN_SETTINGS = {
    # Usamos default=... para que si falta el .env, no explote
    "site_title": env('ADMIN_HEADER', default='Terramar Admin'),
    "site_header": env('PROJECT_NAME', default='Terramar ERP'),
    "site_brand": env('PROJECT_NAME', default='Terramar ERP'),
    "welcome_sign": f"Bienvenido a {env('PROJECT_NAME', default='Terramar')}",
    "copyright": "Terramar Ltd",
    "search_model": "core.Cliente", # Nota: Funcionar√° cuando crees el modelo Cliente
    
    # Men√∫ lateral
    "show_sidebar": True,
    "navigation_expanded": True,
    
    # --- ACTIVAR EL CONSTRUCTOR VISUAL (UI BUILDER) ---
    "show_ui_builder": True, 
    
    # Iconos para tus apps (FontAwesome)
    "icons": {
        # Identidad
        "core.Marca": "fas fa-store",
        "core.ConfiguracionVisual": "fas fa-paint-brush",
        
        # Sedes
        "core.Sede": "fas fa-map-marker-alt",
        "core.Mesa": "fas fa-chair",
        "catalogo.InsumoCritico": "fas fa-exclamation-triangle",
        
        # Carta
        "catalogo.Categoria": "fas fa-list",
        "catalogo.Plato": "fas fa-utensils",
        
        # Personas
        "core.PerfilEmpleado": "fas fa-user-tie",
        "core.Cliente": "fas fa-users",
        "auth.User": "fas fa-key",

        # Pedidos
        "pedidos.Pedido": "fas fa-cash-register",
    },
}

# --- AJUSTES VISUALES (Aqu√≠ se guardar√°n tus colores) ---
JAZZMIN_UI_TWEAKS = {
    "navbar_small_text": False,
    "footer_small_text": False,
    "body_small_text": False,
    "brand_small_text": False,
    "brand_colour": False,
    "accent": "accent-primary",
    "navbar": "navbar-white navbar-light",
    "no_navbar_border": False,
    "navbar_fixed": False,
    "layout_boxed": False,
    "footer_fixed": False,
    "sidebar_fixed": False,
    "sidebar": "sidebar-dark-primary",
    "sidebar_nav_small_text": False,
    "sidebar_disable_expand": False,
    "sidebar_nav_child_indent": False,
    "sidebar_nav_compact_style": False,
    "sidebar_nav_legacy_style": False,
    "sidebar_nav_flat_style": False,
    "theme": "flatly", # <--- AQU√ç PUEDES CAMBIAR EL TEMA (Ej: darkly, journal, solar)
    "dark_mode_theme": None,
    "button_classes": {
        "primary": "btn-primary",
        "secondary": "btn-secondary",
        "info": "btn-info",
        "warning": "btn-warning",
        "danger": "btn-danger",
        "success": "btn-success"
    }
}


# --- ORDENAMIENTO DEL PANEL (ADMIN REORDER) ---

ADMIN_REORDER = (
    # GRUPO 1: Identidad Corporativa (Lo que toca el due√±o estrat√©gico)
    {
        'app': 'core', 
        'label': 'üè¢ Identidad y Marketing', 
        'models': (
            'core.Marca', 
            'core.ConfiguracionVisual',  # Temas Navidad/Verano
        )
    },
    
    # GRUPO 2: Gesti√≥n de Locales (Lo f√≠sico)
    {
        'app': 'core', 
        'label': 'üìç Gesti√≥n de Sedes', 
        'models': (
            'core.Sede',
            'core.Mesa',
            'catalogo.InsumoCritico', # El "Kill Switch" va aqu√≠ porque es operativo
        )
    },

    # GRUPO 3: El Men√∫ (Lo que se vende)
    {
        'app': 'catalogo', 
        'label': 'üçî Carta Digital', 
        'models': (
            'catalogo.Categoria',
            'catalogo.Plato',
            # Nota: Variante est√° dentro de Plato, as√≠ que no necesitamos listarla aqu√≠
        )
    },

    # GRUPO 4: Personas (Usuarios)
    {
        'app': 'core', 
        'label': 'üë• Usuarios y Clientes', 
        'models': (
            'core.PerfilEmpleado', # Tus empleados
            'core.Cliente',        # Tus clientes fidelizados
            'auth.User',           # Usuarios del sistema (Login)
            # 'auth.Group',        # Grupos (Opcional, si no lo usas, com√©ntalo)
        )
    },
    
    # GRUPO 5: Administraci√≥n T√©cnica (Opcional, para ti)
    # Si tienes otras apps como 'pedidos', agr√©galas en otro grupo cuando las crees.

    {
        'app': 'pedidos', 
        'label': 'üí∞ Gesti√≥n de Ventas', 
        'models': (
            'pedidos.Pedido',
            # 'pedidos.DetallePedido', # Opcional: Descomenta si quieres ver los platos sueltos
        )
    },

)

============================================================
ARCHIVO: .\config\urls.py
============================================================
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from catalogo.views import toggle_variante
from pedidos import views 

urlpatterns = [
    path('admin/toggle-variante/<int:variante_id>/', toggle_variante, name='toggle_variante'),
    path('admin/', admin.site.urls),

    # 1. RUTA DE INICIO
    path('', views.catalogo_general, name='menu'), 

    # 2. RUTAS DE CARRITO
    path('agregar/<int:variante_id>/', views.agregar_carrito, name='agregar_carrito'),
    path('sumar/<int:variante_id>/', views.sumar_plato, name='sumar_plato'),
    path('restar/<int:variante_id>/', views.restar_plato, name='restar_plato'),
    path('eliminar/<int:variante_id>/', views.eliminar_carrito, name='eliminar_carrito'),
    path('limpiar/', views.limpiar_carrito, name='limpiar_carrito'),
    path('carrito/', views.ver_carrito, name='ver_carrito'),
    path('toggle-status/<int:variante_id>/', views.toggle_variante_status, name='toggle_variante_status'),

    # --- 3. NUEVA RUTA AJAX (¬°ESTA ES LA CLAVE!) ---
    # Esta ruta es la que usa JavaScript para pedir solo los platos sin recargar
    path('ajax/platos/<slug:marca_slug>/', views.ajax_platos_by_marca, name='ajax_platos_marca'),

    # 4. RUTA DEL CAT√ÅLOGO POR MARCA (Navegaci√≥n normal)
    path('<slug:marca_slug>/', views.catalogo_por_marca, name='catalogo_marca'),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)



============================================================
ARCHIVO: .\config\wsgi.py
============================================================
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()


============================================================
ARCHIVO: .\config\__init__.py
============================================================


============================================================
ARCHIVO: .\core\admin.py
============================================================
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.contrib.auth.models import User, Group
from .models import Marca, ConfiguracionVisual, Sede, Mesa, PerfilEmpleado, Cliente

# Configuraci√≥n de Textos del Panel
# 1. Configuraci√≥n General del Panel
#admin.site.site_header = "Terramar Admin"
#admin.site.site_title = "Portal de Gesti√≥n"
#admin.site.index_title = "Panel de Control"
#admin.site.unregister(Group) # Opcional: Para limpiar la vista
# NOTA: Cambiamos 'ModelAdmin' (de Unfold) por 'admin.ModelAdmin' (Est√°ndar)

# 2. Integraci√≥n de Usuarios (Ver Empleado/Cliente dentro del Usuario)
class EmpleadoInline(admin.StackedInline):
    model = PerfilEmpleado
    can_delete = False
    verbose_name_plural = 'Rol de Empleado'

class ClienteInline(admin.StackedInline):
    model = Cliente
    can_delete = False
    verbose_name_plural = 'Datos de Cliente (Fidelizaci√≥n)'

class UserAdmin(BaseUserAdmin):
    inlines = (EmpleadoInline, ClienteInline)

# Reemplazamos el admin de usuarios original
admin.site.unregister(User)
admin.site.register(User, UserAdmin)

# 3. Administraci√≥n de Marca e Identidad
@admin.register(Marca)
class MarcaAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'activo', 'color_coorporativo')
    list_editable = ('activo',)

@admin.register(ConfiguracionVisual)
class VisualAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'marca', 'activo', 'efecto_especial', 'color_principal')
    list_editable = ('activo', 'efecto_especial') # Edici√≥n r√°pida del switch
    list_filter = ('marca', 'efecto_especial')
    
    fieldsets = (
        ('Gesti√≥n', {'fields': ('marca', 'nombre', 'activo')}),
        ('Apariencia', {'fields': ('color_principal', 'color_secundario', 'color_fondo', 'efecto_especial')}),
        ('Textos', {'fields': ('mensaje_barra', 'mensaje_despedida')}),
    )

# 4. Administraci√≥n Operativa (Sedes y Mesa)
@admin.register(Sede)
class SedeAdmin(admin.ModelAdmin):
    # Esto habilitar√° la edici√≥n r√°pida tipo Excel en la lista
    list_display = ('nombre', 'estado_actual', 'tiempo_extra_saturacion', 'tiempo_delivery_base')
    list_editable = ('estado_actual', 'tiempo_extra_saturacion')
    list_filter = ('estado_actual',)

@admin.register(Mesa)
class MesaAdmin(admin.ModelAdmin):
    list_display = ('numero', 'sede', 'estado', 'capacidad')
    list_filter = ('sede', 'estado')
    search_fields = ('numero',)
    #list_editable = ('estado',)

@admin.register(Cliente)
class ClienteAdmin(admin.ModelAdmin):
    list_display = ('usuario', 'dni', 'telefono', 'nivel')
    search_fields = ('dni', 'usuario__username')

============================================================
ARCHIVO: .\core\apps.py
============================================================
from django.apps import AppConfig


class CoreConfig(AppConfig):
    name = 'core'


============================================================
ARCHIVO: .\core\context_processors.py
============================================================
from .models import Marca, ConfiguracionVisual

def informacion_marca(request):
    """
    Busca la MARCA ACTIVA y su CONFIGURACI√ìN VISUAL (Navidad, Verano, etc.)
    para inyectarla en el HTML.
    """
    marca = Marca.objects.filter(activo=True).first()
    
    ctx = {
        'MARCA': marca,
        'COLOR_PRINCIPAL': '#003366', # Default Azul
        'COLOR_SECUNDARIO': '#FF6B4A', # Default Naranja
        'TEMA_CSS': 'DEFAULT',
        'MENSAJE_TOP': ''
    }

    if marca:
        # Buscamos si hay un tema visual activo (Navidad, etc)
        tema = ConfiguracionVisual.objects.filter(marca=marca, activo=True).first()
        if tema:
            ctx['COLOR_PRINCIPAL'] = tema.color_principal
            ctx['COLOR_SECUNDARIO'] = tema.color_secundario
            ctx['TEMA_CSS'] = tema.efecto_especial
            ctx['MENSAJE_TOP'] = tema.mensaje_barra

    return ctx

============================================================
ARCHIVO: .\core\models.py
============================================================
from django.db import models
from django.contrib.auth.models import User
# ==============================================================================
# 1. IDENTIDAD Y DISE√ëO (MARCA BLANCA)
# ==============================================================================
class Marca(models.Model):
    nombre = models.CharField(max_length=50, unique=True)
    slug = models.SlugField(unique=True, help_text="Identificador para URL (Ej: terramar)")
    color_coorporativo = models.CharField(max_length=7, default="#003366")
    activo = models.BooleanField(default=True)
    #logo = models.ImageField(upload_to='marcas/', blank=True, null=True)
    def __str__(self):
        return self.nombre

class ConfiguracionVisual(models.Model):
    nombre = models.CharField(max_length=50, help_text="Ej: Tema Verano 2025")
    marca = models.ForeignKey(Marca, on_delete=models.CASCADE, related_name='temas')
    activo = models.BooleanField(default=False, help_text="Al activar este, se desactivan los dem√°s autom√°ticamente")

    # --- Personalizaci√≥n Visual ---
    color_principal = models.CharField(max_length=7, default="#003366", help_text="Barra superior y botones principales")
    color_secundario = models.CharField(max_length=7, default="#FF6B4A", help_text="Ofertas y botones de acci√≥n")
    color_fondo = models.CharField(max_length=7, default="#F4F7F6", help_text="Fondo de la p√°gina")

    # --- Mensajes ---
    mensaje_barra = models.CharField(max_length=200, default="Bienvenido", help_text="Texto arriba del todo")
    mensaje_despedida = models.CharField(max_length=200, default="¬°Gracias por tu compra!", help_text="Mensaje al finalizar")

    # --- Efectos Especiales ---
    EFECTOS = [
        ('NINGUNO', 'Sin efectos (Limpio)'),
        ('NIEVE', '‚ùÑÔ∏è Ca√≠da de Nieve (Navidad)'),
        ('CONFETI', 'üéâ Lluvia de Confeti (Aniversario)'),
        ('OSCURO', 'üåô Modo Oscuro (Elegante)'),
        ('PERU', 'üáµüá™ Modo Patrio'),
    ]
    efecto_especial = models.CharField(max_length=20, choices=EFECTOS, default='NINGUNO')
    #banner_promo = models.ImageField(upload_to='campanas/', blank=True, null=True)

    def save(self, *args, **kwargs):
        # Si activo este tema, apago todos los dem√°s de la misma marca
        if self.activo:
            ConfiguracionVisual.objects.filter(marca=self.marca).update(activo=False)
        super().save(*args, **kwargs)

    def __str__(self):
        estado = "üü¢ EN USO" if self.activo else "‚ö™ Guardado"
        return f"{self.nombre} - {estado}"

# ==============================================================================
# 2. ESTRUCTURA OPERATIVA (FRANQUICIA)
# ==============================================================================
class Sede(models.Model):
    nombre = models.CharField(max_length=100)
    direccion = models.CharField(max_length=200)
    telefono = models.CharField(max_length=20)
    #Semaforo
    ESTADOS_OPERATIVOS = [
        ('NORMAL', 'Operacion Normal'), #verde
        ('SATURADO', 'Alta Demanda (+Tiempo)'), #Amarillo
        ('PAUSA', 'Pausa (No recibir pedidos)'), #Naranja
        ('CERRADO', 'Cierre Total'), #Rojo
    ]
    estado_actual = models.CharField(max_length=20, choices=ESTADOS_OPERATIVOS, default='NORMAL')
    #Tiempos por sede
    tiempo_delivery_base = models.IntegerField(default=30, help_text="Tiempo base promedio en esta zona")
    tiempo_extra_saturacion = models.IntegerField(default=45)
    
    def __str__(self):
        return f"{self.nombre} ({self.estado_actual})"


# MODELO DE MESAS (Por SEDE)
class Mesa(models.Model):
    sede = models.ForeignKey(Sede, on_delete=models.CASCADE, related_name="mesas")
    numero = models.CharField(max_length=20) 
    capacidad = models.IntegerField(default=4)
    qr_hash = models.CharField(max_length=100, blank=True, null=True, help_text="C√≥digo √∫nico para el QR")

    ESTADOS_MESA = [
        ('LIBRE', 'Libre'),
        ('OCUPADA', 'Ocupada'),
        ('PAGANDO','Pagando'),
    ]

    estado = models.CharField(max_length=20, choices=ESTADOS_MESA, default='LIBRE')
    
    def __str__(self):
        return f"{self.sede.nombre} - {self.numero}"
    
# ==============================================================================
# 3. USUARIOS Y ROLES (SEGURIDAD)
# ==============================================================================
class PerfilEmpleado(models.Model):
    usuario = models.OneToOneField(User, on_delete=models.CASCADE, related_name='empleado')
    sede = models.ForeignKey(Sede, on_delete=models.SET_NULL, null=True, blank=True)
    
    ROLES = [
        ('ADMIN_GLOBAL', 'üëë Super Admin (Due√±o)'),
        ('ADMIN_SEDE', 'üëî Gerente de Local'),
        ('CAJERO', 'üíª Cajero'),
        ('COCINA', 'üç≥ Chef / Cocina'),
        ('MOZO', 'üìù Mesero'),
    ]
    rol = models.CharField(max_length=20, choices=ROLES, default='MOZO')
    pin_acceso = models.CharField(max_length=4, blank=True, null=True, help_text="PIN para Tablet")

    def __str__(self):
        return f"{self.usuario.get_full_name()} ({self.get_rol_display()})"

class Cliente(models.Model):

    usuario = models.OneToOneField(User, on_delete=models.CASCADE, related_name='perfil_cliente')
    dni = models.CharField(max_length=8, unique=True, blank=True, null=True)
    telefono = models.CharField(max_length=15)
    puntos_acumulados = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    
    NIVELES = [('BRONCE', 'ü•â Nuevo'), ('PLATA', 'ü•à Frecuente'), ('ORO', 'ü•á VIP')]
    nivel = models.CharField(max_length=10, choices=NIVELES, default='BRONCE')

    def __str__(self):
        return f"{self.usuario.first_name} ({self.nivel})"

class DireccionCliente(models.Model):
    cliente = models.ForeignKey(Cliente, on_delete=models.CASCADE, related_name='direcciones')
    nombre = models.CharField(max_length=50) # Casa, Oficina
    direccion = models.CharField(max_length=200)
    referencia = models.CharField(max_length=200, blank=True)
    
    def __str__(self):
        return f"{self.nombre}: {self.direccion}"

============================================================
ARCHIVO: .\core\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARCHIVO: .\core\views.py
============================================================
from django.shortcuts import render

# Create your views here.


============================================================
ARCHIVO: .\core\__init__.py
============================================================


============================================================
ARCHIVO: .\dashboard\admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARCHIVO: .\dashboard\apps.py
============================================================
from django.apps import AppConfig


class DashboardConfig(AppConfig):
    name = 'dashboard'


============================================================
ARCHIVO: .\dashboard\models.py
============================================================
from django.db import models

# Create your models here.


============================================================
ARCHIVO: .\dashboard\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARCHIVO: .\dashboard\views.py
============================================================
from django.shortcuts import render

# Create your views here.


============================================================
ARCHIVO: .\dashboard\__init__.py
============================================================


============================================================
ARCHIVO: .\pedidos\admin.py
============================================================
from django.contrib import admin
from .models import Pedido, DetallePedido
# Register your models here.

class DetalleInline(admin.TabularInline):
    model = DetallePedido
    extra = 0
    readonly_fields = ('subtotal',) # Que nadie edite el subtotal a mano

@admin.register(Pedido)
class PedidoAdmin(admin.ModelAdmin):
    list_display = ('id', 'sede', 'nombre_contacto', 'estado', 'total', 'fecha_creacion')
    list_filter = ('sede', 'estado', 'fecha_creacion')
    search_fields = ('nombre_contacto', 'id')
    inlines = [DetalleInline] # Muestra los platos dentro del pedido


============================================================
ARCHIVO: .\pedidos\apps.py
============================================================
from django.apps import AppConfig


class PedidosConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'pedidos'
    def ready(self):
        import pedidos.signals # <--- ESTA L√çNEA ES VITAL



============================================================
ARCHIVO: .\pedidos\carrito.py
============================================================
from decimal import Decimal
from django.conf import settings
from catalogo.models import Variante

class Carrito:
    def __init__(self, request):
        self.session = request.session
        # USAMOS UNA SOLA CLAVE PARA LA SESI√ìN
        cart = self.session.get('carrito_terramar')
        if not cart:
            cart = self.session['carrito_terramar'] = {}
        self.carrito = cart

    def agregar(self, variante_id, cantidad=1):
        variante_id = str(variante_id)
        if variante_id not in self.carrito:
            self.carrito[variante_id] = {
                'cantidad': 0,
                'precio': 0
            }
        self.carrito[variante_id]['cantidad'] += int(cantidad)
        self.guardar()

    def restar(self, variante_id):
        variante_id = str(variante_id)
        if variante_id in self.carrito:
            self.carrito[variante_id]['cantidad'] -= 1
            if self.carrito[variante_id]['cantidad'] <= 0:
                self.eliminar(variante_id)
            else:
                self.guardar()

    def eliminar(self, variante_id):
        variante_id = str(variante_id)
        if variante_id in self.carrito:
            del self.carrito[variante_id]
            self.guardar()

    def limpiar(self):
        self.session['carrito_terramar'] = {}
        self.session.modified = True

    def guardar(self):
        self.session.modified = True

    def __len__(self):
        return sum(item['cantidad'] for item in self.carrito.values())

    def get_total_precio(self):
        total = Decimal('0.00')
        ids = self.carrito.keys()
        variantes = Variante.objects.filter(id__in=ids)
        for var in variantes:
            cantidad = self.carrito[str(var.id)]['cantidad']
            total += var.precio * cantidad
        return total

    def iterar_detalles(self):
        """Devuelve los objetos completos para el HTML"""
        ids = self.carrito.keys()
        variantes = Variante.objects.filter(id__in=ids)
        cart_copy = self.carrito.copy()
        
        for var in variantes:
            cart_copy[str(var.id)]['producto'] = var
            cart_copy[str(var.id)]['subtotal'] = var.precio * cart_copy[str(var.id)]['cantidad']
            yield cart_copy[str(var.id)]

============================================================
ARCHIVO: .\pedidos\cart_tags.py
============================================================
from django import template
from pedidos.carrito import Carrito # Aseg√∫rate de que esta ruta sea correcta

register = template.Library()

@register.filter
def cantidad_en_carrito(variante, request):
    # L√≥gica para obtener el carrito y devolver la cantidad de esta variante
    carrito = Carrito(request)
    return carrito.carrito.get(str(variante.id), {}).get('cantidad', 0)

============================================================
ARCHIVO: .\pedidos\context_processors.py
============================================================
from .carrito import Carrito

def carrito_actual(request):
    return {'carrito': Carrito(request)}

============================================================
ARCHIVO: .\pedidos\models.py
============================================================
from django.db import models
from django.core.validators import MinValueValidator
from core.models import Sede, Mesa, Cliente, PerfilEmpleado
from catalogo.models import Variante # El producto con precio
# Create your models here.
class Pedido(models.Model):
    """
    EL TICKET DE VENTA (CABECERA)
    """
    # 1. Contexto
    sede = models.ForeignKey(Sede, on_delete=models.CASCADE, related_name='pedidos')
    fecha_creacion = models.DateTimeField(auto_now_add=True)
    # 2. Cliente (H√≠brido)
    # Si es cliente fiel, usamos este campo:
    cliente = models.ForeignKey(Cliente, on_delete=models.SET_NULL, null=True, blank=True)
    # Si es invitado (o para el nombre en el ticket), usamos estos:
    nombre_contacto = models.CharField(max_length=100, default="Invitado")
    telefono_contacto = models.CharField(max_length=20, blank=True)
    # 3. Datos de Entrega
    TIPOS = [('MESA', 'Mesa'), ('DELIVERY', 'Delivery'), ('RECOJO', 'Para Llevar')]
    tipo_servicio = models.CharField(max_length=20, choices=TIPOS, default='MESA')
    mesa = models.ForeignKey(Mesa, on_delete=models.SET_NULL, null=True, blank=True)
    direccion_entrega = models.CharField(max_length=200, blank=True)
    # 4. Dinero y Estado
    ESTADOS = [
        ('PENDIENTE', 'üü° Pendiente'),
        ('CONFIRMADO', 'üü† En Cocina'),
        ('LISTO', 'üîµ Listo para Servir'),
        ('ENTREGADO', 'üü¢ Finalizado'),
        ('CANCELADO', 'üî¥ Anulado')
    ]
    estado = models.CharField(max_length=20, choices=ESTADOS, default='PENDIENTE')
    total = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    metodo_pago = models.CharField(max_length=50, default='EFECTIVO')
    def __str__(self):
        return f"Pedido #{self.id} - {self.nombre_contacto}"

class DetallePedido(models.Model):
    """
    LOS PLATOS DEL PEDIDO (ITEMS)
    """
    pedido = models.ForeignKey(Pedido, on_delete=models.CASCADE, related_name='detalles')
    variante = models.ForeignKey(Variante, on_delete=models.PROTECT) # El plato y precio espec√≠fico
    cantidad = models.PositiveIntegerField(default=1)
    # Guardamos el precio del momento (snapshot) por si sube ma√±ana
    precio_unitario = models.DecimalField(max_digits=10, decimal_places=2)
    subtotal = models.DecimalField(max_digits=10, decimal_places=2)
    notas = models.CharField(max_length=200, blank=True, help_text="Ej: Sin picante")
    def save(self, *args, **kwargs):
        # Auto-calculo del subtotal de esta l√≠nea
        self.subtotal = self.precio_unitario * self.cantidad
        super().save(*args, **kwargs)
    def __str__(self):
        return f"{self.cantidad}x {self.variante.plato.nombre}"
    


============================================================
ARCHIVO: .\pedidos\signals.py
============================================================
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver
from django.db.models import Sum
from .models import DetallePedido

@receiver([post_save, post_delete], sender=DetallePedido)
def actualizar_total_pedido(sender, instance, **kwargs):
    pedido = instance.pedido
    # Suma todos los subtotales de este pedido
    resultado = pedido.detalles.aggregate(total_calculado=Sum('subtotal'))
    pedido.total = resultado['total_calculado'] or 0.00
    pedido.save()

============================================================
ARCHIVO: .\pedidos\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARCHIVO: .\pedidos\urls.py
============================================================
from django.urls import path
from . import views

urlpatterns = [
    # 1. Ruta base: Si entras a /pedidos/ te redirige a la primera marca
    path('', views.catalogo_general, name='menu'),

    # 2. Operaciones del carrito (AJAX)
    path('agregar/<int:variante_id>/', views.agregar_carrito, name='agregar_carrito'),
    path('sumar/<int:variante_id>/', views.sumar_plato, name='sumar_plato'),
    path('restar/<int:variante_id>/', views.restar_plato, name='restar_plato'),
    path('eliminar/<int:variante_id>/', views.eliminar_carrito, name='eliminar_carrito'),
    path('limpiar/', views.limpiar_carrito, name='limpiar_carrito'),
    path('carrito/', views.ver_carrito, name='ver_carrito'),

    # 3. Toggle para activar/desactivar platos (Admin)
    path('toggle-status/<int:variante_id>/', views.toggle_variante_status, name='toggle_variante_status'),

    # 4. Ruta de la marca (IMPORTANTE: va al final para no tapar las otras)
    # Usamos <str:> en lugar de <slug:> para permitir espacios ("A Fuego")
    path('<slug:marca_slug>/', views.catalogo_por_marca, name='catalogo_marca'),
    path('ajax/platos/<slug:marca_slug>/', views.ajax_platos_by_marca, name='ajax_platos_marca'),
] 



============================================================
ARCHIVO: .\pedidos\views.py
============================================================
from django.shortcuts import render, redirect, get_object_or_404
from django.http import JsonResponse
from .carrito import Carrito
from catalogo.models import Variante, Categoria
from core.models import Marca 
from django.contrib.admin.views.decorators import staff_member_required

# --- VISTAS DEL CAT√ÅLOGO ---

def catalogo_general(request):
    """Carga la primera marca al entrar a la web."""
    marca_actual = Marca.objects.filter(activo=True).order_by('id').first()
    lista_marcas = list(Marca.objects.filter(activo=True).order_by('id')) 
    categorias = []
    
    if marca_actual:
        categorias = Categoria.objects.filter(
            marca=marca_actual,
            activo=True
        ).prefetch_related('platos', 'platos__variantes').order_by('orden')
        
    context = {
        'marca_actual': marca_actual,
        'todas_marcas': lista_marcas,
        'categorias': categorias,
    }
    return render(request, 'catalogo/menu.html', context)

def catalogo_por_marca(request, marca_slug):
    """Carga completa si el usuario refresca la p√°gina con la URL de la marca."""
    marca_actual = get_object_or_404(Marca, slug=marca_slug)
    lista_marcas = list(Marca.objects.filter(activo=True).order_by('id')) 
    
    categorias = Categoria.objects.filter(
        marca=marca_actual,
        activo=True
    ).prefetch_related('platos', 'platos__variantes').order_by('orden')

    context = {
        'marca_actual': marca_actual,
        'todas_marcas': lista_marcas, 
        'categorias': categorias,
    }
    return render(request, 'catalogo/menu.html', context)

# --- VISTA AJAX (LA MAGIA) ---
def ajax_platos_by_marca(request, marca_slug):
    """
    Esta funci√≥n NO devuelve la p√°gina completa. 
    Solo devuelve el HTML de los platos para insertarlo con JS.
    """
    marca_actual = get_object_or_404(Marca, slug=marca_slug)
    
    categorias = Categoria.objects.filter(
        marca=marca_actual,
        activo=True
    ).prefetch_related('platos', 'platos__variantes').order_by('orden')

    context = {
        'categorias': categorias, # Solo pasamos categor√≠as/platos
    }
    
    # IMPORTANTE: Renderiza SOLO la lista de platos, no el menu.html completo
    return render(request, 'catalogo/platos_list.html', context)

# --- VISTAS DEL CARRITO (Se mantienen igual que ten√≠as) ---
def ver_carrito(request):
    carrito = Carrito(request)
    hay_agotados = False
    ids = carrito.carrito.keys()
    variantes_en_carrito = Variante.objects.filter(id__in=ids).select_related('plato')
    
    for variante in variantes_en_carrito:
        if not variante.esta_disponible:
            hay_agotados = True
            break
            
    return render(request, 'pedidos/carrito_detalle.html', {
        'carrito': carrito,
        'hay_agotados': hay_agotados
    })

def agregar_carrito(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id)

    if not variante.esta_disponible:
        if request.headers.get('x-requested-with') == 'XMLHttpRequest':
            return JsonResponse({
                'status': 'error',
                'message': '¬°Lo sentimos! Esta opci√≥n ya no est√° disponible.'
            })
        return redirect('menu')

    carrito.agregar(variante.id)

    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        item = carrito.carrito.get(str(variante.id), {'cantidad': 0})
        return JsonResponse({
            'status': 'ok',
            'cant_total': len(carrito),
            'cant_producto': item['cantidad']
        })

    return redirect('menu')

def sumar_plato(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id)

    if not variante.esta_disponible:
         return JsonResponse({'status': 'error', 'message': 'No disponible'})

    carrito.agregar(variante.id)
    
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        item = carrito.carrito.get(str(variante.id))
        return JsonResponse({
            'status': 'ok',
            'cantidad': item['cantidad'],
            'subtotal': item['cantidad'] * float(variante.precio),
            'total_global': float(carrito.get_total_precio()),
            'total_items': len(carrito),
            'eliminado': False
        })
    return redirect('ver_carrito')

def restar_plato(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id)
    
    carrito.restar(variante.id)
    
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        item = carrito.carrito.get(str(variante_id))
        eliminado = item is None
        cantidad = item['cantidad'] if not eliminado else 0
        subtotal = (cantidad * float(variante.precio)) if not eliminado else 0

        return JsonResponse({
            'status': 'ok',
            'cantidad': cantidad,
            'subtotal': subtotal,
            'total_global': float(carrito.get_total_precio()),
            'total_items': len(carrito),
            'eliminado': eliminado
        })
    return redirect('ver_carrito')

def check_hay_agotados(carrito):
    ids = carrito.carrito.keys()
    variantes = Variante.objects.filter(id__in=ids).select_related('plato')
    for v in variantes:
        if not v.esta_disponible:
            return True
    return False

def eliminar_carrito(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id) 
    carrito.eliminar(variante.id)
    
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
         sigue_bloqueado = check_hay_agotados(carrito)
         return JsonResponse({
            'status': 'ok',
            'total_global': float(carrito.get_total_precio()),
            'total_items': len(carrito),
            'eliminado': True,
            'hay_agotados': sigue_bloqueado
        })
    return redirect('ver_carrito')

def limpiar_carrito(request):
    carrito = Carrito(request)
    carrito.limpiar()
    return redirect('menu')

@staff_member_required 
def toggle_variante_status(request, variante_id):
    variante = get_object_or_404(Variante, id=variante_id)
    variante.activo = not variante.activo 
    variante.save()
    return redirect(request.META.get('HTTP_REFERER', 'admin:index'))

============================================================
ARCHIVO: .\pedidos\__init__.py
============================================================


============================================================
ARCHIVO: .\templates\base.html
============================================================
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ MARCA.nombre|default:"Restaurante" }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Estilos Din√°micos (Marca Blanca) */
        :root {
            --color-primary: {{ COLOR_PRINCIPAL|default:"#0d6efd" }};
            --color-secondary: {{ COLOR_SECUNDARIO|default:"#6c757d" }};
        }
        
        body { background-color: #f8f9fa; }
        
        .bg-marca { background-color: var(--color-primary) !important; }
        .text-marca { color: var(--color-primary) !important; }
        .btn-marca { background-color: var(--color-secondary); color: white; border: none; }
        
        /* Ajuste para m√≥vil */
        .card-img-top { height: 200px; object-fit: cover; }
        /* Asegura que el Navbar del Carrito est√© por encima de todo */
        .navbar {
            position: fixed; /* Si no es fixed-top, aseg√∫ralo */
            top: 0;
            z-index: 1060; /* ¬°MUY ALTO! Debe ser mayor que el panel de marcas (1050) */
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-marca bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-utensils me-2"></i>{{ MARCA.nombre|default:"Terramar" }}
            </a>
            
            <div class="d-flex">
                <a href="{% url 'ver_carrito' %}" class="btn btn-outline-light border-0 position-relative">
                    <i class="fas fa-shopping-cart fa-lg"></i>
                    
                    <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ carrito|length|default:"0" }}
                    </span>
                </a>
            </div>
        </div>
    </nav>

    {% if MENSAJE_TOP %}
    <div class="bg-warning text-dark text-center py-1 fw-bold small">
        {{ MENSAJE_TOP }}
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="container my-4" style="min-height: 80vh;">
        {% block content %}
        {% endblock %}
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-auto">
        <div class="container">
            <small>&copy; 2025 {{ MARCA.nombre }} - Sistema de Pedidos</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

============================================================
ARCHIVO: .\templates\catalogo\menu.html
============================================================
{% extends 'base.html' %}
{% load cart_tags %} 

{% block content %}

    <style>
        .img-agotada { filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease; }
        .btn-agotado { cursor: not-allowed !important; background-color: #6c757d; border-color: #6c757d; color: white; }
        
        /* ESTILOS BOTONES DE MARCA */
        .btn-marca-custom {
            cursor: pointer;
            color: #6c757d;
            font-weight: bold;
            border: 1px solid #dee2e6;
            margin: 0 5px;
            border-radius: 50rem;
            background: white;
            padding: 8px 16px;
            transition: background-color 0.2s, color 0.2s;
        }

        .btn-marca-custom.activo {
            background-color: #0d6efd !important;
            color: white !important;
            border-color: #0d6efd !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-marca-custom:hover:not(.activo) {
            background-color: #f8f9fa;
        }

        .marcas-sticky-panel {
            position: sticky; 
            top: 50px; 
            z-index: 1040; 
            background-color: #f8f9fa; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            padding: 10px 0;
        }
        
        .contenido-menu-wrapper {
            min-height: 400px; /* Evita saltos bruscos si carga lento */
        }
    </style>

    <div class="text-center mb-4 mt-4" style="margin-top: 70px !important;"> 
        <h1 class="display-6 fw-bold text-secondary">Nuestra Carta</h1>
        <p class="text-muted">Selecciona tus platos favoritos</p>
    </div>

    <div class="container marcas-sticky-panel"> 
        <div class="d-flex justify-content-center flex-wrap">
            {% for m in todas_marcas %}
                <button type="button" 
                        class="btn-marca-custom {% if marca_actual and m.id == marca_actual.id %}activo{% endif %}"
                        id="btn-marca-{{ m.slug }}"
                        onclick="cargarMarca(event, '{{ m.slug }}')">
                    {{ m.nombre|upper }}
                </button>
            {% endfor %}
        </div>
    </div>

    <div class="container mb-5 contenido-menu-wrapper" id="platos-container">
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body"><i class="fas fa-check-circle me-2"></i> ¬°Agregado!</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        {% include 'catalogo/platos_list.html' %} 
    </div>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES PARA MEMORIA DE SCROLL
        // ==========================================
        
        // Objeto para guardar posiciones: { 'terramar': 1200, 'a-fuego': 500 }
        const memoriaScroll = {}; 
        
        // Guardamos cu√°l es la marca actual al cargar la p√°gina por primera vez
        let marcaActualGlobal = "{{ marca_actual.slug|default:'' }}"; 

        // ==========================================
        // 1. FUNCI√ìN DE CARGA CON MEMORIA
        // ==========================================
        function cargarMarca(event, slug) {
            event.preventDefault();
            
            // Si ya estamos en esta marca, no hacemos nada
            if (slug === marcaActualGlobal) return;

            console.log(`Cambiando de ${marcaActualGlobal} a ${slug}`);

            // A. GUARDAR MEMORIA: Antes de irnos, guardamos d√≥nde estamos scrolleados
            memoriaScroll[marcaActualGlobal] = window.scrollY;
            
            // B. ACTUALIZAR REFERENCIA: Ahora la marca actual ser√° la nueva
            marcaActualGlobal = slug;

            const contenedor = document.getElementById('platos-container');
            const url = `/ajax/platos/${slug}/`;

            // Efecto visual
            contenedor.style.opacity = '0.4';

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Error servidor');
                    return response.text();
                })
                .then(html => {
                    // C. CAMBIAR CONTENIDO
                    contenedor.innerHTML = html;

                    // D. ACTUALIZAR BOTONES
                    document.querySelectorAll('.btn-marca-custom').forEach(btn => btn.classList.remove('activo'));
                    const btnActivo = document.getElementById('btn-marca-' + slug);
                    if(btnActivo) btnActivo.classList.add('activo');

                    // E. REACTIVAR FORMULARIOS
                    activarFormulariosCarrito();

                    // F. RESTAURAR SCROLL (LA MAGIA)
                    contenedor.style.opacity = '1';

                    if (memoriaScroll[slug] !== undefined) {
                        // Si ya hab√≠amos estado aqu√≠, volvemos a esa posici√≥n exacta
                        // Usamos un peque√±o timeout para asegurar que el navegador renderiz√≥ la altura
                        setTimeout(() => {
                            window.scrollTo({
                                top: memoriaScroll[slug],
                                behavior: 'auto' // 'auto' es instant√°neo, 'smooth' es suave
                            });
                        }, 10);
                    } else {
                        // Si es la primera vez que entramos a esta marca, vamos al inicio (arriba)
                        // pero respetando el sticky header (ajustamos a 0 o un poco m√°s abajo si quieres)
                        window.scrollTo(0, 0);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    contenedor.style.opacity = '1';
                });
        }

        // ==========================================
        // 2. L√ìGICA DEL CARRITO (Igual que antes)
        // ==========================================
        function activarFormulariosCarrito() {
            const forms = document.querySelectorAll('.form-ajax');
            const toastEl = document.getElementById('liveToast');
            const toast = toastEl ? new bootstrap.Toast(toastEl) : null;
            const cartCounter = document.getElementById('cart-count');

            forms.forEach(form => {
                if (form.getAttribute('data-listo') === 'si') return;
                form.setAttribute('data-listo', 'si');

                form.addEventListener('submit', function (e) {
                    e.preventDefault(); 
                    const url = this.action;
                    const formData = new FormData(this);
                    const btn = this.querySelector('.btn-agregar');
                    const badge = this.querySelector('span[id^="badge-"]');
                    const originalText = btn.innerHTML;

                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    fetch(url, {
                        method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            if(toast) toast.show();
                            if(cartCounter) {
                                cartCounter.innerText = data.cant_total;
                                cartCounter.classList.remove('d-none');
                            }
                            if(badge) {
                                badge.innerText = data.cant_producto;
                                badge.classList.remove('d-none');
                                badge.classList.add('bg-success');
                                setTimeout(() => {
                                    badge.classList.remove('bg-success');
                                    badge.classList.add('bg-dark');
                                }, 500);
                            }
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        } else {
                            Swal.fire({ icon: 'error', title: 'Oops...', text: data.message });
                            btn.innerHTML = 'Agotado';
                            btn.disabled = true;
                        }
                    })
                    .catch(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    });
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            activarFormulariosCarrito();
        });
    </script>

{% endblock %}

============================================================
ARCHIVO: .\templates\catalogo\platos_list.html
============================================================

   {% load cart_tags %}
   {% for categoria in categorias %}
        {% if categoria.platos.exists %}
            <div class="mb-5">
                <h3 class="border-bottom pb-2 mb-4 text-marca">{{ categoria.nombre }}</h3>
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    
                    {% for plato in categoria.platos.all %}
                        <div class="col">
                            <div class="card h-100 shadow-sm {% if not plato.esta_disponible %}border-0 bg-light{% else %}border-0{% endif %}">
                                
                                {% if plato.imagen %}
                                    <img src="{{ plato.imagen.url }}" 
                                         class="card-img-top {% if not plato.esta_disponible %}img-agotada{% endif %}" 
                                         alt="{{ plato.nombre }}">
                                {% else %}
                                    <div class="bg-secondary text-white d-flex align-items-center justify-content-center {% if not plato.esta_disponible %}img-agotada{% endif %}" 
                                         style="height: 200px;">
                                        <i class="fas fa-camera fa-3x"></i>
                                    </div>
                                {% endif %}

                                <div class="card-body">
                                    <h5 class="card-title fw-bold {% if not plato.esta_disponible %}text-muted{% endif %}">
                                        {{ plato.nombre }}
                                        {% if not plato.esta_disponible %}
                                            <span class="badge bg-secondary ms-1" style="font-size: 0.6em;">AGOTADO</span>
                                        {% endif %}
                                    </h5>
                                    
                                    <p class="card-text text-muted small">{{ plato.descripcion|truncatechars:60 }}</p>
                                    
                                    <div class="mt-3">
                                        {% for variante in plato.variantes.all %}
                                            
                                            {% with disponible=variante.esta_disponible %}

                                            <form action="{% url 'agregar_carrito' variante.id %}" method="POST" class="d-flex justify-content-between align-items-center mb-2 form-ajax">
                                                {% csrf_token %}
                                                
                                                <small class="fw-bold {% if not disponible %}text-muted text-decoration-line-through{% else %}text-dark{% endif %}">
                                                    {{ variante.nombre }} - S/ {{ variante.precio }}
                                                </small>
                                                
                                                <div class="d-flex align-items-center">
                                                    
                                                    {% if disponible %}
                                                        {% with cantidad=carrito|cantidad_en_carrito:variante.id %}
                                                            <span id="badge-{{ variante.id }}" 
                                                                class="badge bg-dark me-2 rounded-pill {% if cantidad == 0 %}d-none{% endif %}">
                                                                {{ cantidad }}
                                                            </span>
                                                        {% endwith %}
                                                    {% endif %}

                                                    {% if disponible %}
                                                        <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill btn-agregar">
                                                            Agregar <i class="fas fa-plus ms-1"></i>
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn btn-secondary btn-sm rounded-pill btn-agotado" disabled style="cursor: not-allowed; opacity: 0.6;">
                                                            Agotado <i class="fas fa-ban ms-1"></i>
                                                        </button>
                                                    {% endif %}
                                                    
                                                </div>
                                            </form>

                                            {% endwith %}
                                            
                                        {% empty %}
                                            <small class="text-danger">No hay variantes configuradas.</small>
                                        {% endfor %}
                                    </div>

                                </div>
                            </div>
                        </div>
                        
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% empty %}
        <div class="alert alert-info text-center">¬°Hola! Selecciona una marca arriba o no hay platos cargados a√∫n.</div>
    {% endfor %}


============================================================
ARCHIVO: .\templates\pedidos\carrito_detalle.html
============================================================
{% extends 'base.html' %}

{% block content %}

<style>
    .img-agotada {
        filter: grayscale(100%);
        opacity: 0.6;
    }
    .row-agotada {
        background-color: #f8f9fa !important; /* Fondo gris claro */
        opacity: 0.7;
    }
    .text-agotado {
        text-decoration: line-through;
        color: #999;
    }
</style>

<div class="container">
    <div class="d-flex align-items-center mb-4 mt-4">
        <h2 class="text-secondary mb-0 me-3">üõí Tu Carrito</h2>
        <span id="badge-total-items" class="badge bg-secondary rounded-pill">{{ carrito|length }} items</span>
    </div>

    {% if carrito|length > 0 %}
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4">Plato</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-end">Precio</th>
                                    <th class="text-end pe-4">Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in carrito.iterar_detalles %}
                                    <tr id="row-{{ item.producto.id }}" class="item-row {% if not item.producto.esta_disponible %}row-agotada{% endif %}">
                                        
                                        <td class="ps-4 py-3">
                                            <div class="d-flex align-items-center">
                                                {% if item.producto.imagen %}
                                                    <img src="{{ item.producto.imagen.url }}" 
                                                         class="rounded me-3 {% if not item.producto.esta_disponible %}img-agotada{% endif %}" 
                                                         style="width: 50px; height: 50px; object-fit: cover;">
                                                {% else %}
                                                    <div class="rounded me-3 bg-secondary d-flex align-items-center justify-content-center text-white {% if not item.producto.esta_disponible %}img-agotada{% endif %}" 
                                                         style="width: 50px; height: 50px;">
                                                        <i class="fas fa-utensils"></i>
                                                    </div>
                                                {% endif %}
                                                
                                                <div>
                                                    <strong class="text-dark">
                                                        {{ item.producto.plato.nombre }}
                                                        {% if not item.producto.esta_disponible %}
                                                            <span class="badge bg-danger ms-1" style="font-size: 0.6em;">AGOTADO</span>
                                                        {% endif %}
                                                    </strong><br>
                                                    <small class="text-muted">{{ item.producto.nombre }}</small>
                                                </div>
                                            </div>
                                        </td>

                                        <td class="text-center">
                                            <div class="btn-group shadow-sm" role="group">
                                                <button 
                                                    class="btn btn-outline-secondary btn-sm btn-update" 
                                                    data-action="restar" 
                                                    data-id="{{ item.producto.id }}"
                                                    data-url="{% url 'restar_plato' item.producto.id %}">
                                                    <i class="fas fa-minus small"></i>
                                                </button>
                                                
                                                <span id="qty-{{ item.producto.id }}" class="btn btn-light btn-sm disabled text-dark fw-bold border" style="width: 40px;">
                                                    {{ item.cantidad }}
                                                </span>
                                                
                                                <button 
                                                    class="btn btn-outline-secondary btn-sm btn-update" 
                                                    data-action="sumar" 
                                                    data-id="{{ item.producto.id }}"
                                                    data-url="{% url 'sumar_plato' item.producto.id %}"
                                                    {% if not item.producto.esta_disponible %}disabled{% endif %}>
                                                    <i class="fas fa-plus small"></i>
                                                </button>
                                            </div>
                                        </td>

                                        <td class="text-end text-muted">S/ {{ item.producto.precio }}</td>
                                        
                                        <td class="text-end fw-bold text-dark pe-4">
                                            S/ <span id="subtotal-{{ item.producto.id }}">{{ item.subtotal }}</span>
                                        </td>
                                        
                                        <td class="text-end pe-3">
                                            
                                            <a href="#" 
                                            class="btn btn-outline-danger btn-sm btn-eliminar" 
                                            data-url="{% url 'eliminar_carrito' item.producto.id %}" 
                                            data-id="{{ item.producto.id }}"
                                            
                                            data-agotado="{% if not item.producto.esta_disponible %}true{% else %}false{% endif %}"
                                            >
                                            
                                            <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <a href="{% url 'menu' %}" class="btn btn-outline-dark">
                        <i class="fas fa-arrow-left me-2"></i> Seguir pidiendo
                    </a>
                    <a href="{% url 'limpiar_carrito' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-broom me-1"></i> Vaciar todo
                    </a>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 bg-light">
                    <div class="card-body p-4">
                        <h4 class="card-title text-secondary">Resumen</h4>
                        <hr>
                        <div class="d-flex justify-content-between mb-4 align-items-center">
                            <span class="h5 mb-0">Total a Pagar:</span>
                            <span class="h3 fw-bold text-success mb-0">
                                S/ <span id="total-global">{{ carrito.get_total_precio }}</span>
                            </span>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <div id="alerta-agotados" class="alert alert-danger text-center mb-2 py-2 small border-danger" role="alert" 
                                {% if not hay_agotados %}style="display: none;"{% endif %}>
                                <i class="fas fa-exclamation-triangle me-1"></i> 
                                <strong>¬°Atenci√≥n!</strong> Elimina los items agotados para continuar.
                            </div>
                            
                            <div id="btn-pagar-wrapper">
                                {% if hay_agotados %}
                                    <button class="btn btn-secondary btn-lg py-3 fw-bold disabled" disabled style="cursor: not-allowed; width: 100%;">
                                        PAGAR AHORA <i class="fas fa-lock ms-2"></i>
                                    </button>
                                {% else %}
                                    <a href="#" class="btn btn-success btn-lg py-3 shadow-sm fw-bold" style="width: 100%;">
                                        PAGAR AHORA <i class="fas fa-chevron-right ms-2"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>

                        <div class="text-center mt-3">
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-lock text-success me-1"></i> Transacci√≥n 100% Segura
                            </small>
                            <div class="d-flex justify-content-center align-items-center bg-light rounded-pill py-2 px-3 mx-auto" style="width: fit-content; gap: 15px;">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d1/Yape_text_app_icon.png/320px-Yape_text_app_icon.png" alt="Yape" style="height: 18px; width: auto;" title="Yape">
                                <img src="https://plin.pe/wp-content/themes/plin/favicon/apple-icon-57x57.png" alt="Plin" style="height: 18px; width: auto;" title="Plin">
                                <i class="fab fa-cc-visa fa-1x" style="color: #1a1f71;" title="Visa"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="text-center py-5">
            <h3 class="fw-light">Tu carrito est√° vac√≠o üò¢</h3>
            <p class="text-muted">Parece que a√∫n no has elegido nada delicioso.</p>
            <a href="{% url 'menu' %}" class="btn btn-primary btn-lg mt-3 px-5 rounded-pill">
                Ir al Men√∫
            </a>
        </div>
    {% endif %}
</div>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    // ==========================================
    // 1. MANEJO DE SUMAR Y RESTAR (+ / -)
    // ==========================================
    const botonesUpdate = document.querySelectorAll('.btn-update');
    botonesUpdate.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            procesarPeticion(this);
        });
    });

    // ==========================================
    // 2. MANEJO DE ELIMINAR (Bote de basura)
    // ==========================================
    const botonesEliminar = document.querySelectorAll('.btn-eliminar');
    botonesEliminar.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const botonActual = this;
            
            // Leemos si est√° marcado como agotado desde el HTML
            const esAgotado = botonActual.getAttribute('data-agotado') === 'true';

            if (esAgotado) {
                // CASO A: SI EST√Å AGOTADO -> Eliminar directo (sin preguntar)
                procesarPeticion(botonActual);
            } else {
                // CASO B: SI EST√Å DISPONIBLE -> Preguntar "¬øEst√°s seguro?"
                Swal.fire({
                    title: '¬øEliminar producto?',
                    text: "Se quitar√° este plato de tu carrito",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        procesarPeticion(botonActual);
                    }
                });
            }
        });
    });
    // ==========================================
    // 3. FUNCI√ìN MAESTRA DE PETICI√ìN
    // ==========================================
    function procesarPeticion(btnElement) {
        btnElement.disabled = true; 
        
        // Obtenemos datos
        const url = btnElement.getAttribute('data-url');
        const productId = btnElement.getAttribute('data-id');

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) throw new Error("Error de red");
            return response.json();
        })
        .then(data => {
            // CASO A: √âxito (se sum√≥, rest√≥ o elimin√≥ correctamente)
            if (data.status === 'ok') {
                actualizarUI(data, productId);
            }
            // CASO B: Error (Stock insuficiente al intentar sumar)
            else if (data.status === 'error') {
                Swal.fire({
                    icon: 'error',
                    title: '¬°Ups!',
                    text: data.message, // "No hay suficiente stock..."
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexi√≥n',
                text: 'Por favor intenta recargar la p√°gina'
            });
        })
        .finally(() => {
            // Rehabilitamos bot√≥n si a√∫n existe en el DOM
            if(document.body.contains(btnElement)) {
                btnElement.disabled = false;
            }
        });
    }

    // ==========================================
    //  // 4. ACTUALIZACI√ìN DE LA INTERFAZ (UI)
¬† ¬† // ==========================================
¬† ¬† function actualizarUI(data, productId) {
¬† ¬† ¬† ¬† // A. Actualizar Totales Globales
        const badgeItems = document.getElementById('badge-total-items');
¬† ¬† ¬† ¬† const cartCountNav = document.getElementById('cart-count');
¬† ¬† ¬† ¬† const totalGlobal = document.getElementById('total-global');

¬† ¬† ¬† ¬† if(badgeItems) badgeItems.innerText = data.total_items + ' items';
¬† ¬† ¬† ¬† if(cartCountNav) cartCountNav.innerText = data.total_items;
¬† ¬† ¬† ¬† if(totalGlobal) totalGlobal.innerText = parseFloat(data.total_global).toFixed(2);

¬† ¬† ¬† ¬† // B. Si hay que eliminar la fila visualmente
¬† ¬† ¬† ¬† if (data.eliminado) {
¬† ¬† ¬† ¬† ¬† ¬† const row = document.getElementById(`row-${productId}`);
¬† ¬† ¬† ¬† ¬† ¬† if (row) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† row.style.transition = "all 0.4s ease-out";
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† row.style.transform = "translateX(20px)";
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† row.style.opacity = "0";
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† row.remove();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Si el carrito queda vac√≠o, recargamos
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (data.total_items === 0) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† location.reload();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }, 400);
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† // C. Si es solo actualizaci√≥n de cantidad
¬† ¬† ¬† ¬† ¬† ¬† const qtySpan = document.getElementById(`qty-${productId}`);
¬† ¬† ¬† ¬† ¬† ¬† const subtotalSpan = document.getElementById(`subtotal-${productId}`);
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† if (qtySpan) qtySpan.innerText = data.cantidad;
¬† ¬† ¬† ¬† ¬† ¬† if (subtotalSpan) subtotalSpan.innerText = parseFloat(data.subtotal).toFixed(2);
¬† ¬† ¬† ¬† }

        // --- D. GESTI√ìN DEL BOT√ìN DE PAGO (¬°ESTO ES LO NUEVO!) ---
        // Verificamos si el servidor nos envi√≥ el estado de 'agotados'
        if (typeof data.hay_agotados !== 'undefined') {
            const alerta = document.getElementById('alerta-agotados');
            const btnWrapper = document.getElementById('btn-pagar-wrapper');

            if (data.hay_agotados === false) {
                // CASO 1: YA NO HAY AGOTADOS -> DESBLOQUEAR TODO
                if (alerta) alerta.style.display = 'none'; // Ocultar alerta roja
                
                if (btnWrapper) {
                    btnWrapper.innerHTML = `
                        <a href="#" class="btn btn-success btn-lg py-3 shadow-sm fw-bold" style="width: 100%;">
                            PAGAR AHORA <i class="fas fa-chevron-right ms-2"></i>
                        </a>
                    `;
                }
            } else {
                // CASO 2: A√öN QUEDAN AGOTADOS -> MANTENER BLOQUEADO
                if (alerta) alerta.style.display = 'block'; // Mostrar alerta roja
                
                if (btnWrapper) {
                    btnWrapper.innerHTML = `
                        <button class="btn btn-secondary btn-lg py-3 fw-bold disabled" disabled style="cursor: not-allowed; width: 100%;">
                            PAGAR AHORA <i class="fas fa-lock ms-2"></i>
                        </button>
                    `;
                }
            }
        }
¬† ¬† }

});
</script>

{% endblock %}

============================================================
ARCHIVO: .\templates\pedidos\sin_marcas.html
============================================================
{% extends 'base.html' %}

{% block content %}
<div class="container d-flex flex-column justify-content-center align-items-center" style="min-height: 60vh;">
    
    <div class="text-center p-4">
        <div class="mb-4 text-warning">
            <i class="fas fa-utensils fa-4x"></i>
        </div>

        <h1 class="fw-bold text-secondary mb-3">¬°Estamos renovando el men√∫!</h1>
        
        <p class="lead text-muted mb-4">
            En este momento estamos actualizando nuestros deliciosos platos.<br>
            Por favor, vuelve a intentarlo en unos minutos.
        </p>

        <a href="#" class="btn btn-success rounded-pill px-4">
            <i class="fab fa-whatsapp me-2"></i> Contactar al restaurante
        </a>
    </div>

</div>
{% endblock %}