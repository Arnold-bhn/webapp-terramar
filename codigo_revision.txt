============================================================
ARCHIVO: config/settings.py
============================================================
from pathlib import Path
import os
import environ
# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent
# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.1/howto/deployment/checklist/
env = environ.Env()
env_file = BASE_DIR / '.env'
if env_file.exists():
    environ.Env.read_env(str(env_file))
else:
    print(f"‚ö†Ô∏è  ALERTA: No encuentro el archivo en: {env_file}")
    print("‚ö†Ô∏è  Verifica que el archivo se llame '.env' y no '.env.txt'")
# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = env('SECRET_KEY', default='django-insecure-clave-de-respaldo-para-desarrollo')
# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = env.bool('DEBUG', default = False)
ALLOWED_HOSTS = []
# Application definition

INSTALLED_APPS = [
    'jazzmin',
    #'unfold', #tema blanco
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    #Mis Archivos Terramar
    'core',
    'catalogo',
    'pedidos',
    'dashboard',
    'admin_reorder',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'admin_reorder.middleware.ModelAdminReorder',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'core.context_processors.informacion_marca',
                'pedidos.context_processors.carrito_actual',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

# Database
# https://docs.djangoproject.com/en/5.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Password validation
# https://docs.djangoproject.com/en/5.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# Internationalization
# https://docs.djangoproject.com/en/5.1/topics/i18n/

LANGUAGE_CODE = 'es-pe'

TIME_ZONE = 'America/Lima'

USE_I18N = True

USE_TZ = True

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.1/howto/static-files/

STATIC_URL = 'static/'

# URL p√∫blica (lo que escribe el navegador)
MEDIA_URL = '/media/'

# Ruta f√≠sica (d√≥nde se guardan en tu PC)
MEDIA_ROOT = BASE_DIR / 'media'

# Default primary key field type
# https://docs.djangoproject.com/en/5.1/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# --- CONFIGURACI√ìN DE JAZZMIN (ADMIN PANEL) ---
JAZZMIN_SETTINGS = {
    # Usamos default=... para que si falta el .env, no explote
    "site_title": env('ADMIN_HEADER', default='Terramar Admin'),
    "site_header": env('PROJECT_NAME', default='Terramar ERP'),
    "site_brand": env('PROJECT_NAME', default='Terramar ERP'),
    "welcome_sign": f"Bienvenido a {env('PROJECT_NAME', default='Terramar')}",
    "copyright": "Terramar Ltd",
    "search_model": "core.Cliente", # Nota: Funcionar√° cuando crees el modelo Cliente
    # Men√∫ lateral
    "show_sidebar": True,
    "navigation_expanded": True,
    # --- ACTIVAR EL CONSTRUCTOR VISUAL (UI BUILDER) ---
    "show_ui_builder": True, 
    # Iconos para tus apps (FontAwesome)
    "icons": {
        # Identidad
        "core.Marca": "fas fa-store",
        "core.ConfiguracionVisual": "fas fa-paint-brush",
        # Sedes
        "core.Sede": "fas fa-map-marker-alt",
        "core.Mesa": "fas fa-chair",
        "catalogo.InsumoCritico": "fas fa-exclamation-triangle",
        # Carta
        "catalogo.Categoria": "fas fa-list",
        "catalogo.Plato": "fas fa-utensils",
        # Personas
        "core.PerfilEmpleado": "fas fa-user-tie",
        "core.Cliente": "fas fa-users",
        "auth.User": "fas fa-key",
        # Pedidos
        "pedidos.Pedido": "fas fa-cash-register",
    },
}
# --- AJUSTES VISUALES (Aqu√≠ se guardar√°n tus colores) ---
JAZZMIN_UI_TWEAKS = {
    "navbar_small_text": False,
    "footer_small_text": False,
    "body_small_text": False,
    "brand_small_text": False,
    "brand_colour": False,
    "accent": "accent-primary",
    "navbar": "navbar-white navbar-light",
    "no_navbar_border": False,
    "navbar_fixed": False,
    "layout_boxed": False,
    "footer_fixed": False,
    "sidebar_fixed": False,
    "sidebar": "sidebar-dark-primary",
    "sidebar_nav_small_text": False,
    "sidebar_disable_expand": False,
    "sidebar_nav_child_indent": False,
    "sidebar_nav_compact_style": False,
    "sidebar_nav_legacy_style": False,
    "sidebar_nav_flat_style": False,
    "theme": "flatly", # <--- AQU√ç PUEDES CAMBIAR EL TEMA (Ej: darkly, journal, solar)
    "dark_mode_theme": None,
    "button_classes": {
        "primary": "btn-primary",
        "secondary": "btn-secondary",
        "info": "btn-info",
        "warning": "btn-warning",
        "danger": "btn-danger",
        "success": "btn-success"
    }
}

# --- ORDENAMIENTO DEL PANEL (ADMIN REORDER) ---
ADMIN_REORDER = (
    # GRUPO 1: Identidad Corporativa (Lo que toca el due√±o estrat√©gico)
    {
        'app': 'core', 
        'label': 'üè¢ Identidad y Marketing', 
        'models': (
            'core.Marca', 
            'core.ConfiguracionVisual',  # Temas Navidad/Verano
        )
    },
    # GRUPO 2: Gesti√≥n de Locales (Lo f√≠sico)
    {
        'app': 'core', 
        'label': 'üìç Gesti√≥n de Sedes', 
        'models': (
            'core.Sede',
            'core.Mesa',
            'catalogo.InsumoCritico', # El "Kill Switch" va aqu√≠ porque es operativo
        )
    },
    # GRUPO 3: El Men√∫ (Lo que se vende)
    {
        'app': 'catalogo', 
        'label': 'üçî Carta Digital', 
        'models': (
            'catalogo.Categoria',
            'catalogo.Plato',
            # Nota: Variante est√° dentro de Plato, as√≠ que no necesitamos listarla aqu√≠
        )
    },
    # GRUPO 4: Personas (Usuarios)
    {
        'app': 'core', 
        'label': 'üë• Usuarios y Clientes', 
        'models': (
            'core.PerfilEmpleado', # Tus empleados
            'core.Cliente',        # Tus clientes fidelizados
            'auth.User',           # Usuarios del sistema (Login)
            # 'auth.Group',        # Grupos (Opcional, si no lo usas, com√©ntalo)
        )
    },
    # GRUPO 5: Administraci√≥n T√©cnica (Opcional, para ti)
    # Si tienes otras apps como 'pedidos', agr√©galas en otro grupo cuando las crees.
    {
        'app': 'pedidos', 
        'label': 'üí∞ Gesti√≥n de Ventas', 
        'models': (
            'pedidos.Pedido',
            # 'pedidos.DetallePedido', # Opcional: Descomenta si quieres ver los platos sueltos
        )
    },
)

============================================================
ARCHIVO: config/urls.py
============================================================
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from catalogo.views import toggle_variante
from pedidos import views 

urlpatterns = [
    path('admin/toggle-variante/<int:variante_id>/', toggle_variante, name='toggle_variante'),
    path('admin/', admin.site.urls),
    path('', views.catalogo_general, name='menu'), 
    path('agregar/<int:variante_id>/', views.agregar_carrito, name='agregar_carrito'),
    path('sumar/<int:variante_id>/', views.sumar_plato, name='sumar_plato'),
    path('restar/<int:variante_id>/', views.restar_plato, name='restar_plato'),
    path('eliminar/<int:variante_id>/', views.eliminar_carrito, name='eliminar_carrito'),
    path('limpiar/', views.limpiar_carrito, name='limpiar_carrito'),
    path('carrito/', views.ver_carrito, name='ver_carrito'),
    path('toggle-status/<int:variante_id>/', views.toggle_variante_status, name='toggle_variante_status'),
    path('ajax/platos/<slug:marca_slug>/', views.ajax_platos_by_marca, name='ajax_platos_marca'),
    path('<slug:marca_slug>/', views.catalogo_por_marca, name='catalogo_marca'),
]
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

============================================================
ARCHIVO: catalogo/models.py
============================================================
from django.db import models
from core.models import Marca, Sede
class InsumoCritico(models.Model):
    sede = models.ForeignKey(Sede, on_delete=models.CASCADE, related_name='insumos')
    nombre = models.CharField(max_length=50, help_text="Ej: Pescado, Lim√≥n, Gas")
    disponible = models.BooleanField(default=True, help_text="Desmarcar para apagar todos los platos relacionados")
    def __str__(self):
        estado = "‚úÖ" if self.disponible else "‚ùå AGOTADO"
        return f"{self.nombre} ({self.sede.nombre}) - {estado}"

class Categoria(models.Model):
    marca = models.ForeignKey(Marca, on_delete=models.CASCADE, related_name='categorias')
    nombre = models.CharField(max_length=50)
    nombre_singular = models.CharField(
        max_length=50, 
        blank=True, 
        null=True, 
        help_text="Ej: 'Chicharron' (para que salga 'Chicharron de Pollo')"
    )
    #imagen = models.ImageField(upload_to='categorias/', blank=True, null=True)
    orden = models.IntegerField(default=0, help_text="1 sale primero, 2 despu√©s ...")
    activo = models.BooleanField(default=True)
    class Meta:
        ordering = ['orden']
    def __str__(self):
        return f"{self.marca.nombre} - {self.nombre}"

class Plato(models.Model):
    marca = models.ForeignKey(Marca, on_delete=models.CASCADE, related_name='platos')
    categoria = models.ForeignKey(Categoria, on_delete=models.CASCADE, related_name='platos')
    nombre = models.CharField(max_length=100)
    descripcion = models.TextField(blank=True, help_text="Descripci√≥n para la web")
    imagen = models.ImageField(upload_to='platos/', blank=True, null=True)
    activo_manual = models.BooleanField(default=True, help_text="Apagar este plato manualmente")
    insumos_clave = models.ManyToManyField(InsumoCritico, blank=True)
    orden = models.IntegerField(default=0, help_text="1 sale primero, 2 despu√©s...")
     class Meta:
        ordering = ['orden', 'nombre']
    def __str__(self):
        if self.categoria.nombre_singular:
            prefijo = self.categoria.nombre_singular
        else:
            prefijo = self.categoria.nombre
        return f"{prefijo} de {self.nombre}"
    @property
    def esta_disponible(self):
        if not self.activo_manual:
            return False
        hay_insumos_agotados = self.insumos_clave.filter(disponible=False).exists()
        if hay_insumos_agotados:
            return False # Bloqueamos el paso
        return True # Todo ok, pase usted

class Variante(models.Model):
    plato = models.ForeignKey(Plato, on_delete=models.CASCADE, related_name='variantes')
    nombre = models.CharField(max_length=50, default="Est√°ndar", help_text="Ej: Personal, Fuente, Vaso")
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    activo = models.BooleanField(default=True, verbose_name="¬øDisponible?", help_text="Desmarcar si se agot√≥ solo esta presentaci√≥n")
    def __str__(self):
        return f"{self.plato.nombre} - {self.nombre} (S/ {self.precio})"
    @property
    def esta_disponible(self):
        return self.activo and self.plato.esta_disponible
    
============================================================
ARCHIVO: catalogo/views.py
============================================================
from django.shortcuts import render
from .models import Categoria, Plato
from pedidos.carrito import Carrito
from django.shortcuts import get_object_or_404, redirect
from django.contrib.admin.views.decorators import staff_member_required
from .models import Variante

def menu_digital(request):
    categorias = Categoria.objects.all().prefetch_related(
        'platos', 
        'platos__insumos_clave', # <--- ESTO ES VITAL: Trae los insumos en la misma consulta
        'platos__variantes'
    )
    carrito = Carrito(request)
    context = {
        'categorias': categorias,
        'carrito': carrito,
    }
    return render(request, 'catalogo/menu.html', context)

@staff_member_required # Solo administradores pueden usar esto
def toggle_variante(request, variante_id):
    variante = get_object_or_404(Variante, id=variante_id)
    variante.activo = not variante.activo # Aqu√≠ invertimos el estado (On <-> Off)
    variante.save()
    return redirect(request.META.get('HTTP_REFERER', '/admin/'))

============================================================
ARCHIVO: pedidos/models.py
============================================================
from django.db import models
from django.core.validators import MinValueValidator
from core.models import Sede, Mesa, Cliente, PerfilEmpleado
from catalogo.models import Variante # El producto con precio
# Create your models here.
class Pedido(models.Model):
    sede = models.ForeignKey(Sede, on_delete=models.CASCADE, related_name='pedidos')
    fecha_creacion = models.DateTimeField(auto_now_add=True)
    cliente = models.ForeignKey(Cliente, on_delete=models.SET_NULL, null=True, blank=True)
    nombre_contacto = models.CharField(max_length=100, default="Invitado")
    telefono_contacto = models.CharField(max_length=20, blank=True)
    TIPOS = [('MESA', 'Mesa'), ('DELIVERY', 'Delivery'), ('RECOJO', 'Para Llevar')]
    tipo_servicio = models.CharField(max_length=20, choices=TIPOS, default='MESA')
    mesa = models.ForeignKey(Mesa, on_delete=models.SET_NULL, null=True, blank=True)
    direccion_entrega = models.CharField(max_length=200, blank=True)
    ESTADOS = [
        ('PENDIENTE', 'üü° Pendiente'),
        ('CONFIRMADO', 'üü† En Cocina'),
        ('LISTO', 'üîµ Listo para Servir'),
        ('ENTREGADO', 'üü¢ Finalizado'),
        ('CANCELADO', 'üî¥ Anulado')
    ]
    estado = models.CharField(max_length=20, choices=ESTADOS, default='PENDIENTE')
    total = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    metodo_pago = models.CharField(max_length=50, default='EFECTIVO')
    def __str__(self):
        return f"Pedido #{self.id} - {self.nombre_contacto}"

class DetallePedido(models.Model):
    pedido = models.ForeignKey(Pedido, on_delete=models.CASCADE, related_name='detalles')
    variante = models.ForeignKey(Variante, on_delete=models.PROTECT) # El plato y precio espec√≠fico
    cantidad = models.PositiveIntegerField(default=1)
    precio_unitario = models.DecimalField(max_digits=10, decimal_places=2)
    subtotal = models.DecimalField(max_digits=10, decimal_places=2)
    notas = models.CharField(max_length=200, blank=True, help_text="Ej: Sin picante")
    def save(self, *args, **kwargs):
        self.subtotal = self.precio_unitario * self.cantidad
        super().save(*args, **kwargs)
    def __str__(self):
        return f"{self.cantidad}x {self.variante.plato.nombre}"
    
============================================================
ARCHIVO: pedidos/views.py
============================================================
from django.shortcuts import render, redirect, get_object_or_404
from django.http import JsonResponse
from .carrito import Carrito
from catalogo.models import Variante, Categoria
from core.models import Marca 
from django.contrib.admin.views.decorators import staff_member_required

def catalogo_general(request):
    marca_actual = Marca.objects.filter(activo=True).order_by('id').first()
    lista_marcas = list(Marca.objects.filter(activo=True).order_by('id')) 
    categorias = []
    if marca_actual:
        categorias = Categoria.objects.filter(
            marca=marca_actual,
            activo=True
        ).prefetch_related('platos', 'platos__variantes').order_by('orden')
    context = {
        'marca_actual': marca_actual,
        'todas_marcas': lista_marcas,
        'categorias': categorias,
    }
    return render(request, 'catalogo/menu.html', context)

def catalogo_por_marca(request, marca_slug):
    marca_actual = get_object_or_404(Marca, slug=marca_slug)
    lista_marcas = list(Marca.objects.filter(activo=True).order_by('id')) 
    categorias = Categoria.objects.filter(
        marca=marca_actual,
        activo=True
    ).prefetch_related('platos', 'platos__variantes').order_by('orden')
    context = {
        'marca_actual': marca_actual,
        'todas_marcas': lista_marcas, 
        'categorias': categorias,
    }
    return render(request, 'catalogo/menu.html', context)

def ajax_platos_by_marca(request, marca_slug):
    marca_actual = get_object_or_404(Marca, slug=marca_slug)
    categorias = Categoria.objects.filter(
        marca=marca_actual,
        activo=True
    ).prefetch_related('platos', 'platos__variantes').order_by('orden')
    context = {
        'categorias': categorias, # Solo pasamos categor√≠as/platos
    }
    return render(request, 'catalogo/platos_list.html', context)

def ver_carrito(request):
    carrito = Carrito(request)
    hay_agotados = False
    ids = carrito.carrito.keys()
    variantes_en_carrito = Variante.objects.filter(id__in=ids).select_related('plato')
    for variante in variantes_en_carrito:
        if not variante.esta_disponible:
            hay_agotados = True
            break
    return render(request, 'pedidos/carrito_detalle.html', {
        'carrito': carrito,
        'hay_agotados': hay_agotados
    })
def agregar_carrito(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id)
    if not variante.esta_disponible:
        if request.headers.get('x-requested-with') == 'XMLHttpRequest':
            return JsonResponse({
                'status': 'error',
                'message': '¬°Lo sentimos! Esta opci√≥n ya no est√° disponible.'
            })
        return redirect('menu')
    carrito.agregar(variante.id)
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        item = carrito.carrito.get(str(variante.id), {'cantidad': 0})
        return JsonResponse({
            'status': 'ok',
            'cant_total': len(carrito),
            'cant_producto': item['cantidad']
        })
    return redirect('menu')

def sumar_plato(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id)
    if not variante.esta_disponible:
        return JsonResponse({'status': 'error', 'message': 'No disponible'})
    carrito.agregar(variante.id)
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        item = carrito.carrito.get(str(variante.id))
        return JsonResponse({
            'status': 'ok',
            'cantidad': item['cantidad'],
            'subtotal': item['cantidad'] * float(variante.precio),
            'total_global': float(carrito.get_total_precio()),
            'total_items': len(carrito),
            'eliminado': False
        })
    return redirect('ver_carrito')

def restar_plato(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id)
    carrito.restar(variante.id)
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
        item = carrito.carrito.get(str(variante_id))
        eliminado = item is None
        cantidad = item['cantidad'] if not eliminado else 0
        subtotal = (cantidad * float(variante.precio)) if not eliminado else 0
        return JsonResponse({
            'status': 'ok',
            'cantidad': cantidad,
            'subtotal': subtotal,
            'total_global': float(carrito.get_total_precio()),
            'total_items': len(carrito),
            'eliminado': eliminado
        })
    return redirect('ver_carrito')
def check_hay_agotados(carrito):
    ids = carrito.carrito.keys()
    variantes = Variante.objects.filter(id__in=ids).select_related('plato')
    for v in variantes:
        if not v.esta_disponible:
            return True
    return False
def eliminar_carrito(request, variante_id):
    carrito = Carrito(request)
    variante = get_object_or_404(Variante, id=variante_id) 
    carrito.eliminar(variante.id)
    if request.headers.get('x-requested-with') == 'XMLHttpRequest':
         sigue_bloqueado = check_hay_agotados(carrito)
         return JsonResponse({
            'status': 'ok',
            'total_global': float(carrito.get_total_precio()),
            'total_items': len(carrito),
            'eliminado': True,
            'hay_agotados': sigue_bloqueado
        })
    return redirect('ver_carrito')
def limpiar_carrito(request):
    carrito = Carrito(request)
    carrito.limpiar()
    return redirect('menu')
@staff_member_required 
def toggle_variante_status(request, variante_id):
    variante = get_object_or_404(Variante, id=variante_id)
    variante.activo = not variante.activo 
    variante.save()
    return redirect(request.META.get('HTTP_REFERER', 'admin:index'))

============================================================
ARCHIVO: pedidos/carrito.py
============================================================
from decimal import Decimal
from django.conf import settings
from catalogo.models import Variante
class Carrito:
    def __init__(self, request):
        self.session = request.session
        cart = self.session.get('carrito_terramar')
        if not cart:
            cart = self.session['carrito_terramar'] = {}
        self.carrito = cart
    def agregar(self, variante_id, cantidad=1):
        variante_id = str(variante_id)
        if variante_id not in self.carrito:
            self.carrito[variante_id] = {
                'cantidad': 0,
                'precio': 0
            }
        self.carrito[variante_id]['cantidad'] += int(cantidad)
        self.guardar()
    def restar(self, variante_id):
        variante_id = str(variante_id)
        if variante_id in self.carrito:
            self.carrito[variante_id]['cantidad'] -= 1
            if self.carrito[variante_id]['cantidad'] <= 0:
                self.eliminar(variante_id)
            else:
                self.guardar()
    def eliminar(self, variante_id):
        variante_id = str(variante_id)
        if variante_id in self.carrito:
            del self.carrito[variante_id]
            self.guardar()
    def limpiar(self):
        self.session['carrito_terramar'] = {}
        self.session.modified = True
    def guardar(self):
        self.session.modified = True
    def __len__(self):
        return sum(item['cantidad'] for item in self.carrito.values())
    def get_total_precio(self):
        total = Decimal('0.00')
        ids = self.carrito.keys()
        variantes = Variante.objects.filter(id__in=ids)
        for var in variantes:
            cantidad = self.carrito[str(var.id)]['cantidad']
            total += var.precio * cantidad
        return total
    def iterar_detalles(self):
        ids = self.carrito.keys()
        variantes = Variante.objects.filter(id__in=ids)
        cart_copy = self.carrito.copy()
        for var in variantes:
            cart_copy[str(var.id)]['producto'] = var
            cart_copy[str(var.id)]['subtotal'] = var.precio * cart_copy[str(var.id)]['cantidad']
            yield cart_copy[str(var.id)]

============================================================
ARCHIVO: pedidos/context_processors.py
============================================================
from .carrito import Carrito
def carrito_actual(request):
    return {'carrito': Carrito(request)}

============================================================
ARCHIVO: pedidos/urls.py
============================================================
from django.urls import path
from . import views

urlpatterns = [
    path('', views.catalogo_general, name='menu'),
    path('agregar/<int:variante_id>/', views.agregar_carrito, name='agregar_carrito'),
    path('sumar/<int:variante_id>/', views.sumar_plato, name='sumar_plato'),
    path('restar/<int:variante_id>/', views.restar_plato, name='restar_plato'),
    path('eliminar/<int:variante_id>/', views.eliminar_carrito, name='eliminar_carrito'),
    path('limpiar/', views.limpiar_carrito, name='limpiar_carrito'),
    path('carrito/', views.ver_carrito, name='ver_carrito'),
    path('toggle-status/<int:variante_id>/', views.toggle_variante_status, name='toggle_variante_status'),
    path('<slug:marca_slug>/', views.catalogo_por_marca, name='catalogo_marca'),
    path('ajax/platos/<slug:marca_slug>/', views.ajax_platos_by_marca, name='ajax_platos_marca'),
] 

============================================================
ARCHIVO: pedidos/cart_tags.py
============================================================
from django import template
from pedidos.carrito import Carrito # Aseg√∫rate de que esta ruta sea correcta
register = template.Library()
@register.filter
def cantidad_en_carrito(variante, request):
    carrito = Carrito(request)
    return carrito.carrito.get(str(variante.id), {}).get('cantidad', 0)

============================================================
ARCHIVO: core/models.py
============================================================
from django.db import models
from django.contrib.auth.models import User
# ==============================================================================
# 1. IDENTIDAD Y DISE√ëO (MARCA BLANCA)
# ==============================================================================
class Marca(models.Model):
    nombre = models.CharField(max_length=50, unique=True)
    slug = models.SlugField(unique=True, help_text="Identificador para URL (Ej: terramar)")
    color_coorporativo = models.CharField(max_length=7, default="#003366")
    activo = models.BooleanField(default=True)
    #logo = models.ImageField(upload_to='marcas/', blank=True, null=True)
    def __str__(self):
        return self.nombre

class ConfiguracionVisual(models.Model):
    nombre = models.CharField(max_length=50, help_text="Ej: Tema Verano 2025")
    marca = models.ForeignKey(Marca, on_delete=models.CASCADE, related_name='temas')
    activo = models.BooleanField(default=False, help_text="Al activar este, se desactivan los dem√°s autom√°ticamente")
    color_principal = models.CharField(max_length=7, default="#003366", help_text="Barra superior y botones principales")
    color_secundario = models.CharField(max_length=7, default="#FF6B4A", help_text="Ofertas y botones de acci√≥n")
    color_fondo = models.CharField(max_length=7, default="#F4F7F6", help_text="Fondo de la p√°gina")
    mensaje_barra = models.CharField(max_length=200, default="Bienvenido", help_text="Texto arriba del todo")
    mensaje_despedida = models.CharField(max_length=200, default="¬°Gracias por tu compra!", help_text="Mensaje al finalizar")
    EFECTOS = [
        ('NINGUNO', 'Sin efectos (Limpio)'),
        ('NIEVE', '‚ùÑÔ∏è Ca√≠da de Nieve (Navidad)'),
        ('CONFETI', 'üéâ Lluvia de Confeti (Aniversario)'),
        ('OSCURO', 'üåô Modo Oscuro (Elegante)'),
        ('PERU', 'üáµüá™ Modo Patrio'),
    ]
    efecto_especial = models.CharField(max_length=20, choices=EFECTOS, default='NINGUNO')
    def save(self, *args, **kwargs):
        if self.activo:
            ConfiguracionVisual.objects.filter(marca=self.marca).update(activo=False)
        super().save(*args, **kwargs)
    def __str__(self):
        estado = "üü¢ EN USO" if self.activo else "‚ö™ Guardado"
        return f"{self.nombre} - {estado}"

# ==============================================================================
# 2. ESTRUCTURA OPERATIVA (FRANQUICIA)
# ==============================================================================
class Sede(models.Model):
    nombre = models.CharField(max_length=100)
    direccion = models.CharField(max_length=200)
    telefono = models.CharField(max_length=20)
    ESTADOS_OPERATIVOS = [
        ('NORMAL', 'Operacion Normal'), #verde
        ('SATURADO', 'Alta Demanda (+Tiempo)'), #Amarillo
        ('PAUSA', 'Pausa (No recibir pedidos)'), #Naranja
        ('CERRADO', 'Cierre Total'), #Rojo
    ]
    estado_actual = models.CharField(max_length=20, choices=ESTADOS_OPERATIVOS, default='NORMAL')
    tiempo_delivery_base = models.IntegerField(default=30, help_text="Tiempo base promedio en esta zona")
    tiempo_extra_saturacion = models.IntegerField(default=45)
    def __str__(self):
        return f"{self.nombre} ({self.estado_actual})"

# MODELO DE MESAS (Por SEDE)
class Mesa(models.Model):
    sede = models.ForeignKey(Sede, on_delete=models.CASCADE, related_name="mesas")
    numero = models.CharField(max_length=20) 
    capacidad = models.IntegerField(default=4)
    qr_hash = models.CharField(max_length=100, blank=True, null=True, help_text="C√≥digo √∫nico para el QR")
    ESTADOS_MESA = [
        ('LIBRE', 'Libre'),
        ('OCUPADA', 'Ocupada'),
        ('PAGANDO','Pagando'),
    ]
    estado = models.CharField(max_length=20, choices=ESTADOS_MESA, default='LIBRE')
    def __str__(self):
        return f"{self.sede.nombre} - {self.numero}"
    
# ==============================================================================
# 3. USUARIOS Y ROLES (SEGURIDAD)
# ==============================================================================
class PerfilEmpleado(models.Model):
    usuario = models.OneToOneField(User, on_delete=models.CASCADE, related_name='empleado')
    sede = models.ForeignKey(Sede, on_delete=models.SET_NULL, null=True, blank=True)
    ROLES = [
        ('ADMIN_GLOBAL', 'üëë Super Admin (Due√±o)'),
        ('ADMIN_SEDE', 'üëî Gerente de Local'),
        ('CAJERO', 'üíª Cajero'),
        ('COCINA', 'üç≥ Chef / Cocina'),
        ('MOZO', 'üìù Mesero'),
    ]
    rol = models.CharField(max_length=20, choices=ROLES, default='MOZO')
    pin_acceso = models.CharField(max_length=4, blank=True, null=True, help_text="PIN para Tablet")
    def __str__(self):
        return f"{self.usuario.get_full_name()} ({self.get_rol_display()})"

class Cliente(models.Model):
    usuario = models.OneToOneField(User, on_delete=models.CASCADE, related_name='perfil_cliente')
    dni = models.CharField(max_length=8, unique=True, blank=True, null=True)
    telefono = models.CharField(max_length=15)
    puntos_acumulados = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    NIVELES = [('BRONCE', 'ü•â Nuevo'), ('PLATA', 'ü•à Frecuente'), ('ORO', 'ü•á VIP')]
    nivel = models.CharField(max_length=10, choices=NIVELES, default='BRONCE')
    def __str__(self):
        return f"{self.usuario.first_name} ({self.nivel})"

class DireccionCliente(models.Model):
    cliente = models.ForeignKey(Cliente, on_delete=models.CASCADE, related_name='direcciones')
    nombre = models.CharField(max_length=50) # Casa, Oficina
    direccion = models.CharField(max_length=200)
    referencia = models.CharField(max_length=200, blank=True)
    def __str__(self):
        return f"{self.nombre}: {self.direccion}"
